<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PYTOOLS.cache — A persistent cache mechanism &mdash; PYTOOLS  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="PYTOOLS.ipywidgets — Widget utilities" href="mod_ipywidgets.html" />
    <link rel="prev" title="PYTOOLS.animation — Animation utilities" href="mod_animation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            PYTOOLS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="mod_init.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS</span></code> (top level) — Generic utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod_torch.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.torch</span></code> — Utilities for pytorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod_animation.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.animation</span></code> — Animation utilities</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.cache</span></code> — A persistent cache mechanism</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#an-example">An example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#discussion">Discussion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#persistent-cacheing-and-versioned-functions">Persistent cacheing and versioned functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#persistent-cacheing-with-symbolic-expressions-for-workflow-task-execution">Persistent cacheing with symbolic expressions for workflow task execution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-PYTOOLS.cache">Available types and functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.BlockInfo"><code class="docutils literal notranslate"><span class="pre">BlockInfo</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.BlockInfo.hits"><code class="docutils literal notranslate"><span class="pre">BlockInfo.hits</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.BlockInfo.ncell"><code class="docutils literal notranslate"><span class="pre">BlockInfo.ncell</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.BlockInfo.ncell_error"><code class="docutils literal notranslate"><span class="pre">BlockInfo.ncell_error</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.BlockInfo.ncell_pending"><code class="docutils literal notranslate"><span class="pre">BlockInfo.ncell_pending</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.CacheDB"><code class="docutils literal notranslate"><span class="pre">CacheDB</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheDB.__new__"><code class="docutils literal notranslate"><span class="pre">CacheDB.__new__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheDB.path"><code class="docutils literal notranslate"><span class="pre">CacheDB.path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheDB.dbpath"><code class="docutils literal notranslate"><span class="pre">CacheDB.dbpath</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheDB.storage"><code class="docutils literal notranslate"><span class="pre">CacheDB.storage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheDB.clear_obsolete"><code class="docutils literal notranslate"><span class="pre">CacheDB.clear_obsolete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheDB.items"><code class="docutils literal notranslate"><span class="pre">CacheDB.items()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheDB.clear"><code class="docutils literal notranslate"><span class="pre">CacheDB.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock"><code class="docutils literal notranslate"><span class="pre">CacheBlock</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.__call__"><code class="docutils literal notranslate"><span class="pre">CacheBlock.__call__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.db"><code class="docutils literal notranslate"><span class="pre">CacheBlock.db</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.functor"><code class="docutils literal notranslate"><span class="pre">CacheBlock.functor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.block"><code class="docutils literal notranslate"><span class="pre">CacheBlock.block</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.cacheonly"><code class="docutils literal notranslate"><span class="pre">CacheBlock.cacheonly</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.memory"><code class="docutils literal notranslate"><span class="pre">CacheBlock.memory</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.clear_error"><code class="docutils literal notranslate"><span class="pre">CacheBlock.clear_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.clear_overflow"><code class="docutils literal notranslate"><span class="pre">CacheBlock.clear_overflow()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.info"><code class="docutils literal notranslate"><span class="pre">CacheBlock.info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.items"><code class="docutils literal notranslate"><span class="pre">CacheBlock.items()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.CacheBlock.clear"><code class="docutils literal notranslate"><span class="pre">CacheBlock.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor"><code class="docutils literal notranslate"><span class="pre">AbstractFunctor</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor.getkey"><code class="docutils literal notranslate"><span class="pre">AbstractFunctor.getkey()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor.getval"><code class="docutils literal notranslate"><span class="pre">AbstractFunctor.getval()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor.html"><code class="docutils literal notranslate"><span class="pre">AbstractFunctor.html()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.AbstractStorage"><code class="docutils literal notranslate"><span class="pre">AbstractStorage</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.AbstractStorage.insert"><code class="docutils literal notranslate"><span class="pre">AbstractStorage.insert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.AbstractStorage.lookup"><code class="docutils literal notranslate"><span class="pre">AbstractStorage.lookup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.AbstractStorage.remove"><code class="docutils literal notranslate"><span class="pre">AbstractStorage.remove()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.Functor"><code class="docutils literal notranslate"><span class="pre">Functor</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.__new__"><code class="docutils literal notranslate"><span class="pre">Functor.__new__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.func"><code class="docutils literal notranslate"><span class="pre">Functor.func</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.sig"><code class="docutils literal notranslate"><span class="pre">Functor.sig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.config"><code class="docutils literal notranslate"><span class="pre">Functor.config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.fpickle"><code class="docutils literal notranslate"><span class="pre">Functor.fpickle</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.getkey"><code class="docutils literal notranslate"><span class="pre">Functor.getkey()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.getval"><code class="docutils literal notranslate"><span class="pre">Functor.getval()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Functor.html"><code class="docutils literal notranslate"><span class="pre">Functor.html()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.FileStorage"><code class="docutils literal notranslate"><span class="pre">FileStorage</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.FileStorage.path"><code class="docutils literal notranslate"><span class="pre">FileStorage.path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.FileStorage.insert"><code class="docutils literal notranslate"><span class="pre">FileStorage.insert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.FileStorage.lookup"><code class="docutils literal notranslate"><span class="pre">FileStorage.lookup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.FileStorage.remove"><code class="docutils literal notranslate"><span class="pre">FileStorage.remove()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.FileStorage.getpath"><code class="docutils literal notranslate"><span class="pre">FileStorage.getpath()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.DefaultStorage"><code class="docutils literal notranslate"><span class="pre">DefaultStorage</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.DefaultStorage.dbpath"><code class="docutils literal notranslate"><span class="pre">DefaultStorage.dbpath</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.persistent_cache"><code class="docutils literal notranslate"><span class="pre">persistent_cache()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.Shadow"><code class="docutils literal notranslate"><span class="pre">Shadow</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#PYTOOLS.cache.Shadow.obsolete"><code class="docutils literal notranslate"><span class="pre">Shadow.obsolete()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#PYTOOLS.cache.manage"><code class="docutils literal notranslate"><span class="pre">manage()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mod_ipywidgets.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.ipywidgets</span></code> — Widget utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod_polling.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.polling</span></code> — Generic polling</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod_simpy.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.simpy</span></code> — Utilities for simpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod_experiment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.experiment</span></code> — Utilities for pytorch experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod_tensorboard_manager.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.tensorboard_manager</span></code> — A server of tensorboard servers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PYTOOLS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.cache</span></code> — A persistent cache mechanism</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/mod_cache.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pytools-cache-a-persistent-cache-mechanism">
<h1><a class="reference internal" href="#module-PYTOOLS.cache" title="PYTOOLS.cache"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.cache</span></code></a> — A persistent cache mechanism<a class="headerlink" href="#pytools-cache-a-persistent-cache-mechanism" title="Link to this heading"></a></h1>
<p>This module provides basic persistent cache functionalities.</p>
<section id="an-example">
<h2>An example<a class="headerlink" href="#an-example" title="Link to this heading"></a></h2>
<p>The following piece of code illustrates the use of this module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File:                 demo/cache.py</span>
<span class="c1"># Contributors:         Jean-Marc Andreoli</span>
<span class="c1"># Language:             python</span>
<span class="c1"># Purpose:              Illustration of the cache module</span>
<span class="kn">from</span> <span class="nn">make</span> <span class="kn">import</span> <span class="n">RUN</span><span class="p">;</span> <span class="n">RUN</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span><span class="vm">__file__</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="kn">from</span> <span class="nn">PYTOOLS</span> <span class="kn">import</span> <span class="n">MapExpr</span><span class="p">,</span> <span class="n">versioned</span>
<span class="kn">from</span> <span class="nn">PYTOOLS.cache</span> <span class="kn">import</span> <span class="n">persistent_cache</span>
<span class="n">persistent_cache</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">persistent_cache</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="n">RUN</span><span class="o">.</span><span class="n">dir</span><span class="o">/</span><span class="s1">&#39;cache.dir&#39;</span><span class="p">)</span>

<span class="nd">@persistent_cache</span>
<span class="k">def</span> <span class="nf">simplefunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>

<span class="nd">@persistent_cache</span>
<span class="k">def</span> <span class="nf">longfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">delay</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;longfunc error&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="n">V</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
<span class="nd">@persistent_cache</span>
<span class="nd">@versioned</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vfunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="n">V</span>

<span class="nd">@persistent_cache</span>
<span class="k">def</span> <span class="nf">stepI</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="o">**</span><span class="n">ini</span><span class="p">):</span> <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="s1">&#39;I(</span><span class="si">{}{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">d</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ini</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

<span class="nd">@persistent_cache</span>
<span class="k">def</span> <span class="nf">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">p</span><span class="p">,</span><span class="n">q</span> <span class="o">=</span> <span class="n">fr</span>
  <span class="k">return</span> <span class="n">ChainMap</span><span class="p">({</span><span class="n">to</span><span class="p">:</span><span class="s1">&#39;K(</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="n">q</span><span class="p">],</span><span class="n">r</span><span class="p">)},</span><span class="n">E</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">proc</span><span class="p">(</span><span class="n">rab</span><span class="o">=</span><span class="s1">&#39;ab&#39;</span><span class="p">,</span><span class="n">rbc</span><span class="o">=</span><span class="s1">&#39;bc&#39;</span><span class="p">,</span><span class="n">rabc</span><span class="o">=</span><span class="s1">&#39;abc&#39;</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
  <span class="n">P_ini</span> <span class="o">=</span> <span class="n">MapExpr</span><span class="p">(</span><span class="n">stepI</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
  <span class="n">P_ab</span> <span class="o">=</span> <span class="n">MapExpr</span><span class="p">(</span><span class="n">stepK</span><span class="p">,</span><span class="n">P_ini</span><span class="p">,</span><span class="n">fr</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">),</span><span class="n">to</span><span class="o">=</span><span class="s1">&#39;ab&#39;</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="n">rab</span><span class="p">)</span>
  <span class="n">P_bc</span> <span class="o">=</span> <span class="n">MapExpr</span><span class="p">(</span><span class="n">stepK</span><span class="p">,</span><span class="n">P_ini</span><span class="p">,</span><span class="n">fr</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">),</span><span class="n">to</span><span class="o">=</span><span class="s1">&#39;bc&#39;</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="n">rbc</span><span class="p">)</span>
  <span class="n">P_abc</span> <span class="o">=</span> <span class="n">MapExpr</span><span class="p">(</span><span class="n">stepK</span><span class="p">,</span><span class="n">MapExpr</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">,</span><span class="n">P_ab</span><span class="p">,</span><span class="n">P_bc</span><span class="p">),</span><span class="n">fr</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ab&#39;</span><span class="p">,</span><span class="s1">&#39;bc&#39;</span><span class="p">),</span><span class="n">to</span><span class="o">=</span><span class="s1">&#39;abc&#39;</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="n">rabc</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">P_abc</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>

<span class="n">DEMOS</span> <span class="o">=</span> <span class="p">(</span>
  <span class="p">(</span> <span class="s1">&#39;simplefunc(1,2)&#39;</span><span class="p">,</span> <span class="s1">&#39;simplefunc(1,y=2)&#39;</span><span class="p">,</span> <span class="p">),</span>
  <span class="p">(</span> <span class="s1">&#39;longfunc(42,6)&#39;</span><span class="p">,</span> <span class="s1">&#39;longfunc(None,4)&#39;</span><span class="p">,</span> <span class="p">),</span>
  <span class="p">(</span> <span class="s1">&#39;vfunc(3)&#39;</span><span class="p">,</span> <span class="p">),</span>
  <span class="p">(</span> <span class="s2">&quot;proc()[&#39;abc&#39;]&quot;</span><span class="p">,</span> <span class="s2">&quot;proc(rabc=&#39;abc2&#39;)[&#39;abc&#39;]&quot;</span><span class="p">,</span> <span class="s2">&quot;proc(rbc=&#39;bc2&#39;)[&#39;abc&#39;]&quot;</span><span class="p">,</span> <span class="p">),</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># we are in the master process: for each entry in DEMOS, launch 2 slave processes at 2 sec interval and wait for them</span>
    <span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">sys</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">simplefunc</span><span class="p">,</span><span class="n">longfunc</span><span class="p">,</span><span class="n">vfunc</span><span class="p">,</span><span class="n">stepI</span><span class="p">,</span><span class="n">stepK</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span><span class="vm">__file__</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DEMOS</span><span class="p">)):</span>
      <span class="nb">print</span><span class="p">(</span><span class="mi">80</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
      <span class="n">cmd</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
      <span class="n">cmd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="p">;</span> <span class="n">w1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">cmd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span><span class="p">;</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
      <span class="n">w1</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span> <span class="n">w2</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
      <span class="n">RUN</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># we are in a slave process: run the demo for entry *ind* in DEMOS</span>
    <span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">gc</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;[proc</span><span class="si">{}</span><span class="s1"> @ t=</span><span class="si">%(asctime)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref</span><span class="p">),</span><span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%S&#39;</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">DEMOS</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">)]:</span>
      <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;raised[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Result: </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">expr</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
<p>To illustrate the cross-process capability of the cache, function <code class="xref py py-func docutils literal notranslate"><span class="pre">demo()</span></code> runs each of the demos defined in variable <cite>DEMOS</cite> twice, in two distinct processes started within 2 seconds of each other. When applicable, the cache produced by the first run is reused in the second.</p>
<ul>
<li><p>Using the <code class="xref py py-func docutils literal notranslate"><span class="pre">persistent_cache()</span></code> decorator, function <code class="xref py py-func docutils literal notranslate"><span class="pre">simplefunc()</span></code> is turned into a persistent cache, and invocations of that function reuse the cache from one run to the other. Indeed, the cache is on disk (in folder <em>DIR</em>) and is shared across processes/threads.</p></li>
<li><p>Function <code class="xref py py-func docutils literal notranslate"><span class="pre">longfunc()</span></code> is also turned into a persistent cache. Unlike <code class="xref py py-func docutils literal notranslate"><span class="pre">simplefunc()</span></code>, it takes some time to complete and may raise an exception. The second run hits the same cache cell before the first run has finished to compute it. In that case, the former waits until the latter completes to reuse the cached value. In one demo, that value is an exception, which is raised in both runs (whether waiting occured or not).</p></li>
<li><p>Function <code class="xref py py-func docutils literal notranslate"><span class="pre">vfunc()</span></code> is assigned a version (here the process id, just to show the behaviour when the version changes). Therefore, the persistent cache creates distinct cache blocks for the distinct versions, and there is no reuse of the cached values from one run to the other.</p></li>
<li><p>Function <code class="xref py py-func docutils literal notranslate"><span class="pre">proc()</span></code> builds a closed symbolic expression (instance of <code class="xref py py-class docutils literal notranslate"><span class="pre">Expr</span></code>) which implements the following workflow based on the two cached functions <code class="xref py py-func docutils literal notranslate"><span class="pre">stepI()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code>.</p>
<a class="reference internal image-reference" href="_images/cache.png"><img alt="workflow representation of function :func:`proc`" src="_images/cache.png" style="width: 491.40000000000003px; height: 184.6px;" /></a>
<p>It consists of 4 tasks:</p>
<ul class="simple">
<li><p><cite>P_ini</cite>: calls <code class="xref py py-func docutils literal notranslate"><span class="pre">stepI()</span></code> which returns an input dictionary with keys <cite>‘a’</cite>, <cite>‘b’</cite>, <cite>‘c’</cite> modified by some constant <cite>d</cite></p></li>
<li><p><cite>P_ab</cite>: calls <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code> which chains to the result of the first task (<cite>P_ini</cite>) a dictionary with key <cite>‘ab’</cite> assigned the sum of values of keys <cite>‘a’</cite> and <cite>‘b’</cite> plus some constant <cite>rab</cite></p></li>
<li><p><cite>P_bc</cite>: calls <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code> which chains to the result of the first task (<cite>P_ini</cite>) a dictionary with key <cite>‘bc’</cite> assigned the sum of values of keys <cite>‘b’</cite> and <cite>‘c’</cite> plus some constant <cite>rbc</cite></p></li>
<li><p><cite>P_abc</cite>: calls <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code> which chains to the chained results of the last two tasks (<cite>P_ab,P_bc</cite>) a dictionary with key <cite>‘abc’</cite> assigned the sum of values of keys <cite>‘ab’</cite> and <cite>‘bc’</cite> plus some constant <cite>rabc</cite></p></li>
</ul>
<p>Of course, cacheing such simple operations is not very interesting, but the purpose of the example is to illustrate cacheing in the presence of dependencies between arbitrary tasks which could be much more complex (and computationaly heavy). The logged trace of the computation illustrated in the diagram below shows how the evaluation mechanism of symbolic expressions (called incarnation) in class <code class="xref py py-class docutils literal notranslate"><span class="pre">MapExpr</span></code> and that of map chaining in class <code class="xref py py-class docutils literal notranslate"><span class="pre">collections.ChainMap</span></code> interact with persistent cacheing to provide a flexible workflow implementation.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/cache-diag.png"><img alt="_images/cache-diag.png" src="_images/cache-diag.png" style="width: 822.9px; height: 302.25px;" /></a>
</figure>
<p>Note that this diagram assumes a full garbage collection before each demo, otherwise, some cache accesses are skipped. Indeed, within a process, a persistent cache keeps weak references to all its past accesses (when their values are amenable to weak reference) and reuses them as long as they are not collected.</p>
</li>
</ul>
<p>Typical output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">01</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">simplefunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">simplefunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">simplefunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">simplefunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">simplefunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">06</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">longfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">08</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">08</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">longfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">WAIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">12</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mi">42</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">12</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">12</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">longfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">16</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">longfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">16</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mi">42</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">16</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">16</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">longfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">WAIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">raised</span><span class="p">[</span><span class="n">longfunc</span> <span class="n">error</span><span class="p">]</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">longfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">longfunc</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">raised</span><span class="p">[</span><span class="n">longfunc</span> <span class="n">error</span><span class="p">]</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">vfunc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">vfunc</span><span class="p">{</span><span class="mi">1988</span><span class="p">}(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">vfunc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1991</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">22</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">vfunc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">22</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">vfunc</span><span class="p">{</span><span class="mi">2097</span><span class="p">}(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">22</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">vfunc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2100</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">22</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">proc</span><span class="p">()[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">22</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">22</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">22</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepI</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">ini</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">24</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">24</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">proc</span><span class="p">()[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">ab</span><span class="p">),</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">),</span><span class="n">bc</span><span class="p">),</span><span class="n">abc</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">24</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rabc</span><span class="o">=</span><span class="s1">&#39;abc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">26</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">26</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">26</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepI</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">ini</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">26</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">26</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rabc</span><span class="o">=</span><span class="s1">&#39;abc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">ab</span><span class="p">),</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">),</span><span class="n">bc</span><span class="p">),</span><span class="n">abc2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">26</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rbc</span><span class="o">=</span><span class="s1">&#39;bc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepI</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">ini</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MISS</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepI</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">ini</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">[</span><span class="n">procA</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rbc</span><span class="o">=</span><span class="s1">&#39;bc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">ab</span><span class="p">),</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">),</span><span class="n">bc2</span><span class="p">),</span><span class="n">abc</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">proc</span><span class="p">()[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">proc</span><span class="p">()[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">ab</span><span class="p">),</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">),</span><span class="n">bc</span><span class="p">),</span><span class="n">abc</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rabc</span><span class="o">=</span><span class="s1">&#39;abc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rabc</span><span class="o">=</span><span class="s1">&#39;abc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">ab</span><span class="p">),</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">),</span><span class="n">bc</span><span class="p">),</span><span class="n">abc2</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Computing</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rbc</span><span class="o">=</span><span class="s1">&#39;bc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">PYTOOLS</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">stepK</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="p">[</span><span class="n">procB</span> <span class="o">@</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">]</span> <span class="n">Result</span><span class="p">:</span> <span class="n">proc</span><span class="p">(</span><span class="n">rbc</span><span class="o">=</span><span class="s1">&#39;bc2&#39;</span><span class="p">)[</span><span class="s1">&#39;abc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">ab</span><span class="p">),</span><span class="n">K</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">),</span><span class="n">I</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">),</span><span class="n">bc2</span><span class="p">),</span><span class="n">abc</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Link to this heading"></a></h2>
<section id="persistent-cacheing-and-versioned-functions">
<h3>Persistent cacheing and versioned functions<a class="headerlink" href="#persistent-cacheing-and-versioned-functions" title="Link to this heading"></a></h3>
<p>When a cache cell is created by an invocation, any versioned function which appears in any of its arguments at any level is memorised together with its version, so the cache cell is later missed (but not removed) if the version of any of these functions has changed. For example, suppose a function <code class="docutils literal notranslate"><span class="pre">f</span></code> is persistently cached and has a cell obtained by an invocation <code class="docutils literal notranslate"><span class="pre">f(3,g)</span></code> where <code class="docutils literal notranslate"><span class="pre">g</span></code> is a versioned function. Another invocation of the same <code class="docutils literal notranslate"><span class="pre">f(3,g)</span></code> later in another process may miss the cell for any of the following reasons:</p>
<ul class="simple">
<li><p>the calling function <code class="docutils literal notranslate"><span class="pre">f</span></code> has a new version;</p></li>
<li><p>the argument function <code class="docutils literal notranslate"><span class="pre">g</span></code> has a new version.</p></li>
</ul>
<p>In the example above, the first argument of the persistently cached function <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code> is typically a symbolic expression (instance of class <code class="xref py py-class docutils literal notranslate"><span class="pre">Expr</span></code>) which contains references at different depths to other functions, in particular <code class="xref py py-func docutils literal notranslate"><span class="pre">stepI()</span></code>. So if the latter were versioned and its version changed, the corresponding cache cells for function <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code> would be missed, even if the version of <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code> were not changed.</p>
</section>
<section id="persistent-cacheing-with-symbolic-expressions-for-workflow-task-execution">
<h3>Persistent cacheing with symbolic expressions for workflow task execution<a class="headerlink" href="#persistent-cacheing-with-symbolic-expressions-for-workflow-task-execution" title="Link to this heading"></a></h3>
<p>In a typical workflow task executor (see e.g. function <code class="xref py py-func docutils literal notranslate"><span class="pre">stepK()</span></code> in the example above), the first argument <em>E</em> is typically an instance of <code class="xref py py-class docutils literal notranslate"><span class="pre">MapExpr</span></code> whose configuration describes all the previous tasks in the workflow. Its incarnation is the set of key-value pairs computed by the previous tasks. The new task typically seeks to enrich this set with some new key-value pairs, based on those of <em>E</em>. Since <em>E</em> is immutable, it is not possible to directly update it. There are two possibilities: convert <em>E</em> into a proper dictionary, or keep <em>E</em> as such and use function <code class="xref py py-func docutils literal notranslate"><span class="pre">collections.ChainMap()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">task_exec</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="o">...</span><span class="p">):</span>
  <span class="o">...</span> <span class="c1"># compute some update dictionary D from E and the other arguments</span>
  <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="o">**</span><span class="n">D</span><span class="p">)</span> <span class="c1"># first solution</span>
  <span class="k">return</span> <span class="n">ChainMap</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="o">**</span><span class="n">D</span><span class="p">)</span> <span class="c1"># second solution</span>
</pre></div>
</div>
<p>In both cases, the same key-value pairs are returned. There is an important difference though.</p>
<ul class="simple">
<li><p>In the first solution, <em>E</em> is recursively incarnated by its conversion to a dict, so the cached value contains all the key-value pairs already typically assigned by the previous tasks, to which the new key-value pairs from <em>D</em> are appended. The advantage of that solution is that a single cache lookup gives access to the computed results of all the tasks up to the current one. On the other hand, the drawback is that this cached value is mostly redundant with the cached values of the previous tasks, and these may be very large.</p></li>
<li><p>In the second solution, the cached value essentially holds the new key-value pairs of <em>D</em> together with the configuration of <em>E</em>, not its recursive incarnation, and the former is usually much smaller than the latter. The price to pay is that access to the results of previous tasks now requires re-incarnating <em>E</em> hence re-accessing the cache, but that overhead is often small and worth the economy in overall cache redundancy.</p></li>
</ul>
</section>
</section>
<section id="module-PYTOOLS.cache">
<span id="available-types-and-functions"></span><h2>Available types and functions<a class="headerlink" href="#module-PYTOOLS.cache" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.BlockInfo">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">BlockInfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hits</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ncell</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ncell_error</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ncell_pending</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#PYTOOLS.cache.BlockInfo" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></p>
<p>Create new instance of BlockInfo(hits, ncell, ncell_error, ncell_pending)</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.BlockInfo.hits">
<span class="sig-name descname"><span class="pre">hits</span></span><a class="headerlink" href="#PYTOOLS.cache.BlockInfo.hits" title="Link to this definition"></a></dt>
<dd><p>Alias for field number 0</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.BlockInfo.ncell">
<span class="sig-name descname"><span class="pre">ncell</span></span><a class="headerlink" href="#PYTOOLS.cache.BlockInfo.ncell" title="Link to this definition"></a></dt>
<dd><p>Alias for field number 1</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.BlockInfo.ncell_error">
<span class="sig-name descname"><span class="pre">ncell_error</span></span><a class="headerlink" href="#PYTOOLS.cache.BlockInfo.ncell_error" title="Link to this definition"></a></dt>
<dd><p>Alias for field number 2</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.BlockInfo.ncell_pending">
<span class="sig-name descname"><span class="pre">ncell_pending</span></span><a class="headerlink" href="#PYTOOLS.cache.BlockInfo.ncell_pending" title="Link to this definition"></a></dt>
<dd><p>Alias for field number 3</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">CacheDB</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">listing={}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lock=&lt;unlocked</span> <span class="pre">_thread.lock</span> <span class="pre">object&gt;</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheDB"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheDB" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">MutableMapping</span></code>, <a class="reference internal" href="mod_init.html#PYTOOLS.HtmlPlugin" title="PYTOOLS.HtmlPlugin"><code class="xref py py-class docutils literal notranslate"><span class="pre">HtmlPlugin</span></code></a></p>
<p>Instances of this class manage cache repositories. There is at most one instance of this class in a process for each normalised repository specification path. A cache repository contains cells, each cell corresponding to one cached value produced by a unique call, and possibly reused by later calls. Cells are clustered into blocks, each block grouping cells produced by the same call type, called a functor (of class <a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor" title="PYTOOLS.cache.AbstractFunctor"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractFunctor</span></code></a>). Meta-information about blocks and cells are stored in an index in a sqlite3 database. The values themselves are persistently stored by a dedicated storage object (of class <a class="reference internal" href="#PYTOOLS.cache.AbstractStorage" title="PYTOOLS.cache.AbstractStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractStorage</span></code></a>).</p>
<p>The index entry attached to a block describes the common functor of all the calls which produced its cells. A <code class="docutils literal notranslate"><span class="pre">Block</span></code> entry has the following field:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oid</span></code>: a unique integer identifier of the block;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">functor</span></code>: the functor producing all the cells in the block; each functor is assumed to have a deterministic pickle byte-string which uniquely identifies it.</p></li>
</ul>
<p>The index entry attached to a cell describes the call event which produced it. A <code class="docutils literal notranslate"><span class="pre">Cell</span></code> entry has the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oid</span></code>: a unique integer identifier of the cell; also used to retrieve the value attached to the cell;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">block</span></code>: reference to the <code class="docutils literal notranslate"><span class="pre">Block</span></code> entry holding the functor of the call event which produced the cell;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ckey</span></code>: the key of the call event which produced the cell;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tstamp</span></code>: date of creation, last update or last reuse, of the cell;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hits</span></code>: number of hits (reuse) since creation;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size</span></code>: either 0 if the value is still being computed, or the size in bytes of the computed value, with a negative sign if that value is an exception;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">duration</span></code>: duration (in float sec) of its computation.</p></li>
</ul>
<p>A <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance acts as a mapping object, where the keys are block identifiers (<code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code>) and values are <a class="reference internal" href="#PYTOOLS.cache.CacheBlock" title="PYTOOLS.cache.CacheBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheBlock</span></code></a> objects for the corresponding blocks.</p>
<p>Finally, <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instances have an HTML ipython display.</p>
<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB.__new__">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">__new__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cls</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">listing={}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lock=&lt;unlocked</span> <span class="pre">_thread.lock</span> <span class="pre">object&gt;</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheDB.__new__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheDB.__new__" title="Link to this definition"></a></dt>
<dd><p>Generates a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> object.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>spec</strong> (<a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><em>CacheDB</em></a><em> | </em><em>Path</em><em> | </em><em>str</em>) – specification of the cache folder</p>
</dd>
</dl>
<ul class="simple">
<li><p>If <em>spec</em> is a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance, that instance is returned</p></li>
<li><p>If <em>spec</em> is a path to a directory, returns a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance whose storage is an instance of <a class="reference internal" href="#PYTOOLS.cache.DefaultStorage" title="PYTOOLS.cache.DefaultStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">DefaultStorage</span></code></a> pointing to that directory</p></li>
<li><p>Otherwise, <em>spec</em> must be a path to a file, returns a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance whose storage is unpickled from the file at <em>spec</em>.</p></li>
</ul>
<p>Note that this constructor is locally cached on the resolved path <em>spec</em>.</p>
</dd></dl>

<p>Generates a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> object.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>spec</strong> (<a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><em>CacheDB</em></a><em> | </em><em>Path</em><em> | </em><em>str</em>) – specification of the cache folder</p>
</dd>
</dl>
<ul class="simple">
<li><p>If <em>spec</em> is a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance, that instance is returned</p></li>
<li><p>If <em>spec</em> is a path to a directory, returns a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance whose storage is an instance of <a class="reference internal" href="#PYTOOLS.cache.DefaultStorage" title="PYTOOLS.cache.DefaultStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">DefaultStorage</span></code></a> pointing to that directory</p></li>
<li><p>Otherwise, <em>spec</em> must be a path to a file, returns a <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance whose storage is unpickled from the file at <em>spec</em>.</p></li>
</ul>
<p>Note that this constructor is locally cached on the resolved path <em>spec</em>.</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB.path">
<span class="sig-name descname"><span class="pre">path</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">Path</span></em><a class="headerlink" href="#PYTOOLS.cache.CacheDB.path" title="Link to this definition"></a></dt>
<dd><p>the normalised path of this instance</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB.dbpath">
<span class="sig-name descname"><span class="pre">dbpath</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">str</span></em><a class="headerlink" href="#PYTOOLS.cache.CacheDB.dbpath" title="Link to this definition"></a></dt>
<dd><p>the path to the sqlite database holding the index</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB.storage">
<span class="sig-name descname"><span class="pre">storage</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="#PYTOOLS.cache.AbstractStorage" title="PYTOOLS.cache.AbstractStorage"><span class="pre">AbstractStorage</span></a></em><a class="headerlink" href="#PYTOOLS.cache.CacheDB.storage" title="Link to this definition"></a></dt>
<dd><p>the object managing the actual storage of the values</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB.clear_obsolete">
<span class="sig-name descname"><span class="pre">clear_obsolete</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">strict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dry_run</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheDB.clear_obsolete"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheDB.clear_obsolete" title="Link to this definition"></a></dt>
<dd><p>Clears all the blocks which are obsolete.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB.items">
<span class="sig-name descname"><span class="pre">items</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheDB.items"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheDB.items" title="Link to this definition"></a></dt>
<dd><p>Returns a view on this instance’s blocks.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheDB.clear">
<span class="sig-name descname"><span class="pre">clear</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheDB.clear"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheDB.clear" title="Link to this definition"></a></dt>
<dd><p>Removes all blocks from this instance.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">CacheBlock</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">functor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">block</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cacheonly</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheBlock"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheBlock" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">MutableMapping</span></code>, <a class="reference internal" href="mod_init.html#PYTOOLS.HtmlPlugin" title="PYTOOLS.HtmlPlugin"><code class="xref py py-class docutils literal notranslate"><span class="pre">HtmlPlugin</span></code></a></p>
<p>Instances of this class implements blocks of cells sharing the same functor.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db</strong> (<a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><em>CacheDB</em></a>) – specification of the cache repository where the block resides</p></li>
<li><p><strong>functor</strong> (<a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor" title="PYTOOLS.cache.AbstractFunctor"><em>AbstractFunctor</em></a>) – functor of the block</p></li>
<li><p><strong>cacheonly</strong> (<em>bool</em>) – if <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>, cell creation is disallowed</p></li>
</ul>
</dd>
</dl>
<p>A <a class="reference internal" href="#PYTOOLS.cache.CacheBlock" title="PYTOOLS.cache.CacheBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheBlock</span></code></a> instance is callable, and calls take a single argument. Method <a class="reference internal" href="#PYTOOLS.cache.CacheBlock.__call__" title="PYTOOLS.cache.CacheBlock.__call__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__call__()</span></code></a> implements the cross-process cacheing mechanism which produces and reuses cache cells. It also implements a weak cache for local calls (within its process).</p>
<p>Furthermore, a <a class="reference internal" href="#PYTOOLS.cache.CacheBlock" title="PYTOOLS.cache.CacheBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheBlock</span></code></a> instance acts as a mapping where the keys are cell identifiers (<code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code>) and values are tuples of meta-information about the cells (i.e. not the values of the cells: these are only accessible through calling).</p>
<p>Finally, <a class="reference internal" href="#PYTOOLS.cache.CacheBlock" title="PYTOOLS.cache.CacheBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheBlock</span></code></a> instances have an HTML ipython display.</p>
<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.__call__">
<span class="sig-name descname"><span class="pre">__call__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheBlock.__call__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.__call__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>arg</strong> (<em>Any</em>) – argument of the call</p>
</dd>
</dl>
<p>Implements cacheing as follows:</p>
<ul class="simple">
<li><p>Method <code class="xref py py-meth docutils literal notranslate"><span class="pre">getkey()</span></code> of the functor is invoked with argument <em>arg</em> to obtain a <code class="docutils literal notranslate"><span class="pre">ckey</span></code>.</p></li>
<li><p>If that <code class="docutils literal notranslate"><span class="pre">ckey</span></code> is present in the (local) memory mapping of this block, its associated value is returned.</p></li>
<li><p>Otherwise, a transaction is begun on the index database.</p>
<ul>
<li><p>If there already exists a cell with the same <code class="docutils literal notranslate"><span class="pre">ckey</span></code>, method <code class="xref py py-meth docutils literal notranslate"><span class="pre">lookup()</span></code> of the storage is invoked to obtain a getter for that cell, then the transaction is terminated and the result is extracted, using the obtained getter. The cell’s hit count is incremented.</p></li>
<li><p>If there does not exist a cell with the same <code class="docutils literal notranslate"><span class="pre">ckey</span></code>, a cell with that <code class="docutils literal notranslate"><span class="pre">ckey</span></code> is created, and method <code class="xref py py-meth docutils literal notranslate"><span class="pre">insert()</span></code> of the storage is invoked to obtain a setter for that cell, then the transaction is terminated. Then, method <code class="xref py py-meth docutils literal notranslate"><span class="pre">getval()</span></code> of the functor is invoked with argument <em>arg</em> and its result is stored, even if it is an exception, using the obtained setter.</p></li>
</ul>
</li>
<li><p>If the result is an exception, it is raised.</p></li>
<li><p>Otherwise, the memory mapping of this block is updated at key <code class="docutils literal notranslate"><span class="pre">ckey</span></code> with the result (if possible), and the result is returned.</p></li>
</ul>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.db">
<span class="sig-name descname"><span class="pre">db</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><span class="pre">CacheDB</span></a></em><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.db" title="Link to this definition"></a></dt>
<dd><p>the <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instance this block belongs to</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.functor">
<span class="sig-name descname"><span class="pre">functor</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor" title="PYTOOLS.cache.AbstractFunctor"><span class="pre">AbstractFunctor</span></a></em><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.functor" title="Link to this definition"></a></dt>
<dd><p>the functor for this block (field <code class="docutils literal notranslate"><span class="pre">functor</span></code> in the <code class="docutils literal notranslate"><span class="pre">Block</span></code> table of the index is the functor’s pickle)</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.block">
<span class="sig-name descname"><span class="pre">block</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">int</span></em><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.block" title="Link to this definition"></a></dt>
<dd><p>the identifier of this block (field <code class="docutils literal notranslate"><span class="pre">oid</span></code> in the <code class="docutils literal notranslate"><span class="pre">Block</span></code> table of the index)</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.cacheonly">
<span class="sig-name descname"><span class="pre">cacheonly</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">bool</span></em><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.cacheonly" title="Link to this definition"></a></dt>
<dd><p>whether cell creation is disabled</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.memory">
<span class="sig-name descname"><span class="pre">memory</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">WeakValueDictionary</span></em><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.memory" title="Link to this definition"></a></dt>
<dd><p>a local cache of calls within the current process</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.clear_error">
<span class="sig-name descname"><span class="pre">clear_error</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dry_run</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheBlock.clear_error"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.clear_error" title="Link to this definition"></a></dt>
<dd><p>Clears all the cells from this block which cache an exception.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.clear_overflow">
<span class="sig-name descname"><span class="pre">clear_overflow</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">n</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dry_run</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheBlock.clear_overflow"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.clear_overflow" title="Link to this definition"></a></dt>
<dd><p>Clears all the cells from this block except the <em>n</em> most recent (lru policy).</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.info">
<span class="sig-name descname"><span class="pre">info</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheBlock.info"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.info" title="Link to this definition"></a></dt>
<dd><p>Returns information about this block. Available attributes:
<code class="xref py py-attr docutils literal notranslate"><span class="pre">hits</span></code>, <code class="xref py py-attr docutils literal notranslate"><span class="pre">ncell</span></code>, <code class="xref py py-attr docutils literal notranslate"><span class="pre">ncell_error</span></code>, <code class="xref py py-attr docutils literal notranslate"><span class="pre">ncell_pending</span></code></p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.items">
<span class="sig-name descname"><span class="pre">items</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheBlock.items"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.items" title="Link to this definition"></a></dt>
<dd><p>Returns a view on this instance’s cells.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.CacheBlock.clear">
<span class="sig-name descname"><span class="pre">clear</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#CacheBlock.clear"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.CacheBlock.clear" title="Link to this definition"></a></dt>
<dd><p>Removes all cells from this instance.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractFunctor">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">AbstractFunctor</span></span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractFunctor"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractFunctor" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>An instance of this class defines a type of (single argument) call to be cached.</p>
<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractFunctor.getkey">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">getkey</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractFunctor.getkey"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractFunctor.getkey" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>arg</strong> – an arbitrary python object.</p>
</dd>
</dl>
<p>Returns a byte string which represents <em>arg</em> uniquely.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractFunctor.getval">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">getval</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractFunctor.getval"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractFunctor.getval" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>arg</strong> – an arbitrary python object.</p>
</dd>
</dl>
<p>Returns the result of calling this functor with argument <em>arg</em>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractFunctor.html">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">html</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">ckey</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractFunctor.html"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractFunctor.html" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>ckey</strong> (<em>bytes</em>) – a byte string as returned by invocation of method <a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor.getkey" title="PYTOOLS.cache.AbstractFunctor.getkey"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getkey()</span></code></a></p>
</dd>
</dl>
<p>Returns an HTML formatted representation of the argument of that invocation.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractStorage">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">AbstractStorage</span></span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractStorage"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractStorage" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>An instance of this class stores cached values on a persistent support.</p>
<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractStorage.insert">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">insert</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cell</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractStorage.insert"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractStorage.insert" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>cell</strong> (<em>int</em>) – the identifier of a cell</p>
</dd>
</dl>
<p>Returns the function to call to set a cell value. This method is called inside the transaction which inserts a new cell into a cache index, hence exactly once overall for a given cell. The returned function is then called, but outside the transaction. It is passed the computed value and must return the size in bytes of its storage. The cell may have disappeared from the cache when called, or may disappear while executing, so the assignment may have to later be rolled back.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractStorage.lookup">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cell</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wait</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractStorage.lookup"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractStorage.lookup" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>cell</strong> (<em>int</em>) – the identifier of a cell</p></li>
<li><p><strong>wait</strong> (<em>bool</em>) – whether the cell value is currently being computed by a concurrent thread/process</p></li>
</ul>
</dd>
</dl>
<p>Returns the function to call to get a cell value. This method is called inside the transaction which looks up a cell from a cache index, which may happens multiple times in possibly concurrent threads/processes for a given cell. The returned function is then called, but outside the transaction.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.AbstractStorage.remove">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cell</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#AbstractStorage.remove"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.AbstractStorage.remove" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>cell</strong> (<em>int</em>) – the identifier of a cell</p></li>
<li><p><strong>size</strong> (<em>int</em>) – size of the cell</p></li>
</ul>
</dd>
</dl>
<p>Frees the storage resources associated with a cell. This method is called inside the transaction which deletes a cell from a cache index.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">Functor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fromfunc</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#PYTOOLS.cache.AbstractFunctor" title="PYTOOLS.cache.AbstractFunctor"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractFunctor</span></code></a></p>
<p>An instance of this class defines a functor attached to a python top-level versioned function. The functor is entirely defined by the name of the function, that of its module, its version and its signature. These components are saved on pickling and restored on unpickling, even if the function has disappeared or changed. This is not checked on unpickling, and method <a class="reference internal" href="#PYTOOLS.cache.Functor.getval" title="PYTOOLS.cache.Functor.getval"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getval()</span></code></a> is disabled.</p>
<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.__new__">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">__new__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cls</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fromfunc</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor.__new__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor.__new__" title="Link to this definition"></a></dt>
<dd><p>Generates a functor.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>spec</strong> – a versioned function, defined at the top-level of its module (hence pickable)</p>
</dd>
</dl>
</dd></dl>

<p>Generates a functor.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>spec</strong> – a versioned function, defined at the top-level of its module (hence pickable)</p>
</dd>
</dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.func">
<span class="sig-name descname"><span class="pre">func</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">Callable</span></em><a class="headerlink" href="#PYTOOLS.cache.Functor.func" title="Link to this definition"></a></dt>
<dd><p>the versioned function characterizing this functor</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.sig">
<span class="sig-name descname"><span class="pre">sig</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">Signature</span></em><a class="headerlink" href="#PYTOOLS.cache.Functor.sig" title="Link to this definition"></a></dt>
<dd><p>signature of this functor</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.config">
<span class="sig-name descname"><span class="pre">config</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">tuple</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#PYTOOLS.cache.Shadow" title="PYTOOLS.cache.Shadow"><span class="pre">Shadow</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></em><a class="headerlink" href="#PYTOOLS.cache.Functor.config" title="Link to this definition"></a></dt>
<dd><p>configuration of this functor</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.fpickle">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">fpickle</span></span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor.fpickle"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor.fpickle" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="mod_init.html#PYTOOLS.pickleclass" title="PYTOOLS.pickleclass"><code class="xref py py-class docutils literal notranslate"><span class="pre">pickleclass</span></code></a></p>
<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.fpickle.Pickler">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Pickler</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">protocol</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fix_imports</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">buffer_callback</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor.fpickle.Pickler"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor.fpickle.Pickler" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Pickler</span></code></p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.fpickle.Unpickler">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Unpickler</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fix_imports</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">encoding</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'ASCII'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">errors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'strict'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">buffers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">()</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor.fpickle.Unpickler"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor.fpickle.Unpickler" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Unpickler</span></code></p>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.getkey">
<span class="sig-name descname"><span class="pre">getkey</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor.getkey"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor.getkey" title="Link to this definition"></a></dt>
<dd><p>Argument <em>arg</em> must be a pair of a list of positional arguments and a dict of keyword arguments. They are normalised against the signature of the functor and the pickled value of the result is returned. The pickling of versioned function objects is modified to embed their version.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.getval">
<span class="sig-name descname"><span class="pre">getval</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor.getval"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor.getval" title="Link to this definition"></a></dt>
<dd><p>Argument <em>arg</em> must be a pair of a list of positional arguments and a dict of keyword arguments. Returns the value of calling attribute <a class="reference internal" href="#PYTOOLS.cache.Functor.func" title="PYTOOLS.cache.Functor.func"><code class="xref py py-attr docutils literal notranslate"><span class="pre">func</span></code></a> with that positional argument list and keyword argument dict.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.Functor.html">
<span class="sig-name descname"><span class="pre">html</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">ckey</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Functor.html"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Functor.html" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>ckey</strong> (<em>bytes</em>) – a byte string as returned by invocation of method <a class="reference internal" href="#PYTOOLS.cache.Functor.getkey" title="PYTOOLS.cache.Functor.getkey"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getkey()</span></code></a></p>
</dd>
</dl>
<p>Returns an HTML formatted representation of the argument of that invocation.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.FileStorage">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">FileStorage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#FileStorage"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.FileStorage" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#PYTOOLS.cache.AbstractStorage" title="PYTOOLS.cache.AbstractStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractStorage</span></code></a></p>
<p>Instances of this class manage the persistent storage of cached values using a filesystem directory.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>path</strong> (<em>Path</em>) – the directory to store cached values</p>
</dd>
</dl>
<p>The storage for a cell consists of a content file which contains the value of the cell in pickled format and a cross process mechanism to synchronise access to the content file between writer and possibly multiple readers. The path of the content file as well as that of the file underlying the synch lock are built from the cell id, so as to be unique to that cell. They inherit the access rights of the <a class="reference internal" href="#PYTOOLS.cache.FileStorage.path" title="PYTOOLS.cache.FileStorage.path"><code class="xref py py-attr docutils literal notranslate"><span class="pre">path</span></code></a> directory.</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.FileStorage.path">
<span class="sig-name descname"><span class="pre">path</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">Path</span></em><a class="headerlink" href="#PYTOOLS.cache.FileStorage.path" title="Link to this definition"></a></dt>
<dd><p>Directory where values are stored</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.FileStorage.insert">
<span class="sig-name descname"><span class="pre">insert</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cell</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#FileStorage.insert"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.FileStorage.insert" title="Link to this definition"></a></dt>
<dd><p>Opens the content file path for <em>cell</em> in write mode, acquires the corresponding synch lock, then returns a setter function which pickle-dumps its argument into the content file, closes it and releases the synch lock.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.FileStorage.lookup">
<span class="sig-name descname"><span class="pre">lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cell</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wait</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#FileStorage.lookup"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.FileStorage.lookup" title="Link to this definition"></a></dt>
<dd><p>Opens the content file path for <em>cell</em> in read mode, then returns a getter function which waits for the corresponding synch lock to be released (if <em>wait</em> is True), then pickle-loads the content file and returns the obtained value.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.FileStorage.remove">
<span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cell</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#FileStorage.remove"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.FileStorage.remove" title="Link to this definition"></a></dt>
<dd><p>Removes the content file path for <em>cell</em> as well as the corresponding synch lock.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.FileStorage.getpath">
<span class="sig-name descname"><span class="pre">getpath</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cell</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">masks</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">((0,</span> <span class="pre">31),</span> <span class="pre">(5,</span> <span class="pre">992),</span> <span class="pre">(10,</span> <span class="pre">31744),</span> <span class="pre">(15,</span> <span class="pre">1015808),</span> <span class="pre">(20,</span> <span class="pre">32505856))</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#FileStorage.getpath"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.FileStorage.getpath" title="Link to this definition"></a></dt>
<dd><p>Returns the content file path (as a <code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code> instance) associated to <em>cell</em> (of type <code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code>). It is composed of two parts (a directory name and a file name), joined to the main <a class="reference internal" href="#PYTOOLS.cache.FileStorage.path" title="PYTOOLS.cache.FileStorage.path"><code class="xref py py-attr docutils literal notranslate"><span class="pre">path</span></code></a> attribute. The directory is created if it does not already exist. The concatenation of the directory name (without its prefix <code class="docutils literal notranslate"><span class="pre">X</span></code>) and the file name (without its suffix <code class="docutils literal notranslate"><span class="pre">.pck</span></code>) is the representation of <em>cell</em> in base 32 (digits are 0-9A-V). This mapping of cells to paths ensures that no sub-directory holds more than 1024 cells. It assumes that cells are created sequentially (which is what AUTOINCREMENT in sqlite3 does), so the number of sub-directories grows slowly.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.DefaultStorage">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">DefaultStorage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#DefaultStorage"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.DefaultStorage" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#PYTOOLS.cache.FileStorage" title="PYTOOLS.cache.FileStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">FileStorage</span></code></a></p>
<p>The default storage class for a cache repository. Stores the index database in the same directory as the values, with name <code class="docutils literal notranslate"><span class="pre">index.db</span></code>.</p>
<p>Attributes:</p>
<dl class="field-list simple">
</dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="PYTOOLS.cache.DefaultStorage.dbpath">
<span class="sig-name descname"><span class="pre">dbpath</span></span><a class="headerlink" href="#PYTOOLS.cache.DefaultStorage.dbpath" title="Link to this definition"></a></dt>
<dd><p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code> to the sqlite database holding the index</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="PYTOOLS.cache.persistent_cache">
<span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">persistent_cache</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">f</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">factory=&lt;class</span> <span class="pre">'PYTOOLS.cache.CacheBlock'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">**kwd</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#persistent_cache"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.persistent_cache" title="Link to this definition"></a></dt>
<dd><p>A decorator which makes a function persistently cached. The cached function behaves as the original function except that its invocations are cached and reused when possible. The original function must be defined at the top-level of its module, to be compatible with <a class="reference internal" href="#PYTOOLS.cache.Functor" title="PYTOOLS.cache.Functor"><code class="xref py py-class docutils literal notranslate"><span class="pre">Functor</span></code></a>. If it does not have a version already, it is assigned version <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code>.</p>
<dl class="field-list simple">
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="PYTOOLS.cache.Shadow">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">Shadow</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fromfunc</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Shadow"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Shadow" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Instances of this class are defined from versioned functions (ie. functions defined at the toplevel of their module, and with an attribute <code class="xref py py-attr docutils literal notranslate"><span class="pre">version</span></code> defined). Their state is composed of the name, the module name and the version of the original function. They can be arbitrarily pickled and unpickled and produce a string representation close to that of their origin. However, unpickling does not restore the calling capacity of their origin.</p>
<dl class="py method">
<dt class="sig sig-object py" id="PYTOOLS.cache.Shadow.obsolete">
<span class="sig-name descname"><span class="pre">obsolete</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#Shadow.obsolete"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.Shadow.obsolete" title="Link to this definition"></a></dt>
<dd><p>Returns <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> if this instance is up-to-date. It may be obsolete for two reasons:</p>
<ul class="simple">
<li><p>the function it refers to (by module name and function name) cannot be imported or is not a versioned function: in that case the empty tuple is returned;</p></li>
<li><p>it can be imported as a versioned function, but has a different version from that of this instance: in that case, the pair of the current version of the imported function and the version of this instance is returned.</p></li>
</ul>
<p>Note that this method may import modules which in turn may create cache entries (for new versions of functions). It should therefore not be called in a cache transaction.</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="PYTOOLS.cache.manage">
<span class="sig-prename descclassname"><span class="pre">PYTOOLS.cache.</span></span><span class="sig-name descname"><span class="pre">manage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">paths</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ivname</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'db'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/PYTOOLS/cache.html#manage"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#PYTOOLS.cache.manage" title="Link to this definition"></a></dt>
<dd><p>A simple tool to manage a set of <a class="reference internal" href="#PYTOOLS.cache.CacheDB" title="PYTOOLS.cache.CacheDB"><code class="xref py py-class docutils literal notranslate"><span class="pre">CacheDB</span></code></a> instances, specified by their paths.</p>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mod_animation.html" class="btn btn-neutral float-left" title="PYTOOLS.animation — Animation utilities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mod_ipywidgets.html" class="btn btn-neutral float-right" title="PYTOOLS.ipywidgets — Widget utilities" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Jean-Marc Andreoli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>