<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PYTOOLS &mdash; PYTOOLS  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            PYTOOLS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mod_init.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS</span></code> (top level) — Generic utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_torch.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.torch</span></code> — Utilities for pytorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_animation.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.animation</span></code> — Animation utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_cache.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.cache</span></code> — A persistent cache mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_ipywidgets.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.ipywidgets</span></code> — Widget utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_polling.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.polling</span></code> — Generic polling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_simpy.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.simpy</span></code> — Utilities for simpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_experiment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.experiment</span></code> — Utilities for pytorch experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mod_tensorboard_manager.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.tensorboard_manager</span></code> — A server of tensorboard servers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PYTOOLS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">PYTOOLS</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for PYTOOLS</h1><div class="highlight"><pre>
<span></span><span class="c1"># File:                 __init__.py</span>
<span class="c1"># Creation date:        2014-03-16</span>
<span class="c1"># Contributors:         Jean-Marc Andreoli</span>
<span class="c1"># Language:             python</span>
<span class="c1"># Purpose:              Some utilities in Python</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">logging</span><span class="p">;</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">ast</span><span class="o">,</span><span class="nn">sqlalchemy</span><span class="o">,</span><span class="nn">lxml</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="owrap">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.owrap">[docs]</a>
<span class="k">class</span> <span class="nc">owrap</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Objects of this class present an attribute oriented proxy interface to an underlying mapping object.</span>

<span class="sd">:param __ref__: a reference to a (possibly mutable) mapping object, of which this instance is to be a proxy</span>

<span class="sd">Keys in the reference are turned into attributes of the proxy. If *__ref__* is :const:`None`, the reference is a new empty dictionary, otherwise *__ref__* must be a mapping object, and *__ref__* (or its own reference if it is itself of class :class:`owrap`) is taken as reference. The reference is first updated with the keyword arguments *ka*. Example::</span>

<span class="sd">   r = dict(a=3,b=6); x = owrap(r)</span>
<span class="sd">   assert x.a == 3</span>
<span class="sd">   del x.a; x.b += 7</span>
<span class="sd">   assert r == {&#39;b&#39;:13}</span>
<span class="sd">   r[&#39;c&#39;] = 42</span>
<span class="sd">   assert x.c == 42</span>
<span class="sd">   assert x == r</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">__slot__</span> <span class="o">=</span> <span class="s1">&#39;__ref__&#39;</span><span class="p">,</span>
  <span class="n">__ref__</span><span class="p">:</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The proxy object&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">__ref__</span><span class="p">:</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">__ref__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">r</span><span class="p">:</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">__ref__</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">owrap</span><span class="p">):</span> <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">__ref__</span>
      <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">ka</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;__ref__&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">__ref__</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">owrap</span><span class="p">)</span> <span class="k">else</span> <span class="n">other</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span> <span class="o">!=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">__ref__</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">owrap</span><span class="p">)</span> <span class="k">else</span> <span class="n">other</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
  <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
  <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ref__</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="fmtwrap">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.fmtwrap">[docs]</a>
<span class="k">class</span> <span class="nc">fmtwrap</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class provide a formatting wrapper to an underlying mapping object. Each instance keeps a list of visible keys in the reference object.</span>

<span class="sd">* accessing a key raises an error if it is not visible, otherwises returns the formatted value of that same key in the reference object</span>
<span class="sd">* assigning a key to a value forwards the assignment to the reference object, and also memorises the key as visible. If the key starts with `_`, that character is first dropped and the key is, on the contrary, removed from the visible list if present.</span>
<span class="sd">* deleting a key deletes it from both the reference object and the visible list.</span>

<span class="sd">:param ref: the reference object (a possibly mutable mapping), of which this instance is to be a partial proxy</span>

<span class="sd">E.g.::</span>

<span class="sd">   r = {}; x = fmtwrap(r)</span>
<span class="sd">   x.fmt.update(pi=&#39;{:.3f}&#39;.format,title=str.title)</span>
<span class="sd">   x.update(pi=3.14,title=&#39;the value of pi&#39;,a=&#39;something&#39;,_b=&#39;another&#39;)</span>
<span class="sd">   assert x==dict(pi=&#39;3.140&#39;,title=&#39;The Value Of Pi&#39;,a=&quot;&#39;something&#39;&quot;)</span>
<span class="sd">   assert r==dict(pi=3.14,title=&#39;the value of pi&#39;,a=&#39;something&#39;,b=&#39;another&#39;)</span>
<span class="sd">   del x[&#39;title&#39;]</span>
<span class="sd">   assert x==dict(pi=&#39;3.140&#39;,a=&quot;&#39;something&#39;&quot;) and r==dict(pi=3.14,a=&#39;something&#39;,b=&#39;another&#39;)</span>
<span class="sd">   x.update(pi=3.141592,_a=&#39;boo&#39;)</span>
<span class="sd">   assert x==dict(pi=&#39;3.142&#39;) and r==dict(pi=3.141592,a=&#39;boo&#39;,b=&#39;another&#39;)</span>
<span class="sd">   x.update(z=42)</span>
<span class="sd">   x.fmt.update(z=&#39;{:x}&#39;.format)</span>
<span class="sd">   assert x==dict(pi=&#39;3.142&#39;,z=&#39;2a&#39;) and r==dict(pi=3.141592,a=&#39;boo&#39;,b=&#39;another&#39;,z=42)</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">ref</span><span class="p">:</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The reference mapping object&quot;&quot;&quot;</span>
  <span class="n">fmt</span><span class="p">:</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="nb">str</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The formatters (default is function :func:`repr`)&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="p">{};</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="p">{};</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>
  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">repr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:];</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
  <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">yield from</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">)</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="fmtwrap.describe">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.fmtwrap.describe">[docs]</a>
  <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tab</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">lim</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Pretty-prints out this instance. Each of the possibly multiple lines of output are indented by a prefix given by parameter *tab* and clipped at a number of characters (including the prefix) given by parameter *lim*.&quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span><span class="bp">self</span><span class="p">))</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="n">lim</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="o">-</span><span class="mi">3</span>
    <span class="k">if</span> <span class="n">lim</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span><span class="s1">&#39;...&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">lim</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="n">lim</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">&lt;=</span><span class="n">lim</span><span class="p">:</span> <span class="k">return</span> <span class="n">s</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span><span class="si">}</span><span class="s1">...</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span><span class="si">}</span><span class="s1">&#39;</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)):</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">tab</span><span class="p">,(</span><span class="n">k</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">n</span><span class="p">),(</span><span class="s1">&#39; = &#39;</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;.. &#39;</span><span class="p">),</span><span class="n">clip</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<span class="k">class</span> <span class="nc">forward</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This object allows to name callable members of module/packages without loading them. They are loaded only on actual call. Example::</span>

<span class="sd">   from sys import modules</span>
<span class="sd">   array = forward.numpy.array</span>
<span class="sd">   assert &#39;numpy&#39; not in modules # numpy is not loaded</span>
<span class="sd">   x = array((1,2,3))</span>
<span class="sd">   assert &#39;numpy&#39; in modules and x.shape == (3,) # now numpy is loaded and x is computed</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">__slot__</span> <span class="o">=</span> <span class="s1">&#39;__spec__&#39;</span><span class="p">,</span><span class="s1">&#39;__value__&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="p">()):</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value__</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span><span class="o">+</span><span class="p">(</span><span class="n">a</span><span class="p">,))</span>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value__</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__value__</span> <span class="o">=</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span><span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span>
  <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value__</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;forward&lt;</span><span class="si">{}{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span><span class="p">),(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value__</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;:incarnated&#39;</span><span class="p">))</span>
<span class="n">forward</span> <span class="o">=</span> <span class="n">forward</span><span class="p">()</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="namedtuple">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.namedtuple">[docs]</a>
<span class="k">def</span> <span class="nf">namedtuple</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns a class of tuples with named fields. It is identical to :func:`collections.namedtuple`, with only two additions:</span>

<span class="sd">* The returned class has an attribute :attr:`_field_index` which is an instance of that class where each field is set to its index in the field list. e.g.::</span>

<span class="sd">   c = namedtuple(&#39;c&#39;,&#39;u v&#39;)</span>
<span class="sd">   assert c._field_index.u == 0 and c._field_index.v == 1</span>

<span class="sd">* Furthermore, if *f* and *x* are instances of the returned class *c*, then calling *f* with argument *x* returns a new instance of class *c* in which each field is set to the result of applying the corresponding field in *f* (which must be a callable) to the corresponding field in *x*. Additional keyword arguments can be passed to the calls. E.g.::</span>

<span class="sd">   c = namedtuple(&#39;c&#39;,&#39;u v&#39;)</span>
<span class="sd">   f = c(u=(lambda z,r=0.: 2.*z+r),v=(lambda z,r=0.: 3.*z+5.*r))</span>
<span class="sd">   x = c(u=3,v=5)</span>
<span class="sd">   k = dict(r=42)</span>
<span class="sd">   assert f(x,**k) == c(u=f.u(x.u,**k),v=f.v(x.v,**k))</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
  <span class="bp">cls</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
  <span class="bp">cls</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">**</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">)))</span>
  <span class="bp">cls</span><span class="o">.</span><span class="n">_field_index</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)))</span>
  <span class="k">return</span> <span class="bp">cls</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="config_xdg">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.config_xdg">[docs]</a>
<span class="k">def</span> <span class="nf">config_xdg</span><span class="p">(</span><span class="n">rsc</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">dflt</span><span class="p">:</span><span class="n">Any</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param rsc: the name of an XDG resource</span>
<span class="sd">:param dflt: a default value</span>

<span class="sd">Returns the content of the XDG resource named *rsc* or *dflt* if the resource is not found.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="k">try</span><span class="p">:</span> <span class="kn">from</span> <span class="nn">xdg.BaseDirectory</span> <span class="kn">import</span> <span class="n">load_first_config</span>
  <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="n">dflt</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">load_first_config</span><span class="p">(</span><span class="n">rsc</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">dflt</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span> <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="config_env">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.config_env">[docs]</a>
<span class="k">def</span> <span class="nf">config_env</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">dflt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">asfile</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param name: the name of an environment variable</span>
<span class="sd">:param dflt: a default value</span>
<span class="sd">:param asfile: whether to treat the value of the environment variable as a path to a file</span>

<span class="sd">Returns the string value of an environment variable (or the content of the file pointed by it if *asfile* is set) or *dflt* if the environment variable is not assigned.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">dflt</span>
  <span class="k">if</span> <span class="n">asfile</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span> <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="autoconfig">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.autoconfig">[docs]</a>
<span class="k">def</span> <span class="nf">autoconfig</span><span class="p">(</span><span class="n">module</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">dflt</span><span class="p">:</span><span class="n">Any</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">asfile</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param module: the name of a module</span>
<span class="sd">:param name: the name of a configuration parameter for that module</span>
<span class="sd">:param dflt: a default value for the configuration parameter</span>
<span class="sd">:param asfile: whether to treat the value of the environment variable as a path to a file</span>

<span class="sd">Returns an object obtained from an environment variable whose name is derived from *module* and *name*. For example, if *module* is ``mypackage.mymodule`` and *name* is ``myparam`` then the environment variable is ``MYPACKAGE_MYMODULE_MYPARAM``. The value of that variable (or the content of the file pointed by it if *asfile* is set) is executed in an empty dictionary and the value attached to key *name* is returned. If the variable is not assigned, *dflt* is returned.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">config_env</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">asfile</span><span class="o">=</span><span class="n">asfile</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
    <span class="n">d</span><span class="p">:</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">dflt</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="HtmlPlugin">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.HtmlPlugin">[docs]</a>
<span class="k">class</span> <span class="nc">HtmlPlugin</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class have an ipython HTML representation. The representation is by default simply the string representation of the instance (enclosed in a ``span`` element), but can be customised if it supports method :meth:`as_html`.</span>

<span class="sd">Method :meth:`as_html` should only be defined for hashable objects. It takes as input a function *_* and returns the base HTML representation of the object (as understood by module :mod:`lxml.html`). If invoked on a compound object, it should not recursively invoke method :meth:`as_html` on its components to obtain their HTML representations, because that would be liable to unmanageable repetitions (if two components share a common sub-component) or infinite recursions. Instead, the representation of a component object should be obtained by calling function *_* with that object as argument. It returns a &quot;pointer&quot; in the form of a string ``?``\ *n* (within a ``span`` element) where *n* is a unique reference number. The scope of such pointers is the toplevel call of method :meth:`_repr_html_`, which guarantees that two occurrences of equal objects will have the same pointer.</span>

<span class="sd">The :class:`HtmlPlugin` representation of an object is a ``table`` element whose head row is the base HTML representation of that object (including its pointers), and whose body rows align each pointer reference to the base HTML representation of its referenced object (possibly containing pointers itself, recursively). In the following example, the base HTML representation of a node in a graph is given by its label followed by the sequence of pointers to its successor nodes::</span>

<span class="sd">   class N (HtmlPlugin): # class of nodes in a (possibly cyclic) directed graph</span>
<span class="sd">     def __init__(self,tag,*succ): self.tag,self.succ = tag,list(succ)</span>
<span class="sd">     def as_html(self,_):</span>
<span class="sd">       from lxml.html.builder import E</span>
<span class="sd">       return E.div(E.b(self.tag),&#39;[|&#39;,*(y for x in self.succ for y in (_(x),&#39;|&#39;)),&#39;]&#39;)</span>
<span class="sd">   # Let&#39;s build a trellis DAG</span>
<span class="sd">   n = N(&#39;&#39;)</span>
<span class="sd">   na,nb,nc = N(&#39;a&#39;,n),N(&#39;b&#39;,n),N(&#39;c&#39;,n)</span>
<span class="sd">   nab,nbc,nac = N(&#39;ab&#39;,na,nb),N(&#39;bc&#39;,nb,nc),N(&#39;ac&#39;,na,nc)</span>
<span class="sd">   nabc = N(&#39;abc&#39;,nab,nbc,nac)</span>
<span class="sd">   # n.succ.append(nabc) # makes the graph cyclic</span>
<span class="sd">   from IPython.display import display</span>
<span class="sd">   display(nabc)</span>

<span class="sd">produces (up to some attributes):</span>

<span class="sd">.. code-block:: html</span>

<span class="sd">   &lt;table&gt;</span>
<span class="sd">     &lt;!-- thead: base HTML representation (with pointers) of the initial object --&gt;</span>
<span class="sd">     &lt;thead&gt;&lt;tr&gt;&lt;td colspan=&quot;2&quot;&gt; &lt;div&gt;&lt;b&gt;abc&lt;/b&gt;[|&lt;span&gt;?1&lt;/span&gt;|&lt;span&gt;?5&lt;/span&gt;|&lt;span&gt;?7&lt;/span&gt;|]&lt;/div&gt; &lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;</span>
<span class="sd">     &lt;!-- tbody: mapping each pointer to the base HTML representation of its reference --&gt;</span>
<span class="sd">     &lt;tbody&gt;</span>
<span class="sd">       &lt;tr&gt; &lt;th&gt;?1&lt;/th&gt; &lt;td&gt; &lt;div&gt;&lt;b&gt;ab&lt;/b&gt;[|&lt;span&gt;?2&lt;/span&gt;|&lt;span&gt;?4&lt;/span&gt;|]&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt;</span>
<span class="sd">       &lt;tr&gt; &lt;th&gt;?2&lt;/th&gt; &lt;td&gt; &lt;div&gt;&lt;b&gt;a&lt;/b&gt;[|&lt;span&gt;?3&lt;/span&gt;|]&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt;</span>
<span class="sd">       &lt;tr&gt; &lt;th&gt;?3&lt;/th&gt; &lt;td&gt; &lt;div&gt;&lt;b&gt;&lt;/b&gt;[|]&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt;</span>
<span class="sd">       &lt;tr&gt; &lt;th&gt;?4&lt;/th&gt; &lt;td&gt; &lt;div&gt;&lt;b&gt;b&lt;/b&gt;[|&lt;span&gt;?3&lt;/span&gt;|]&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt;</span>
<span class="sd">       &lt;tr&gt; &lt;th&gt;?5&lt;/th&gt; &lt;td&gt; &lt;div&gt;&lt;b&gt;bc&lt;/b&gt;[|&lt;span&gt;?4&lt;/span&gt;|&lt;span&gt;?6&lt;/span&gt;|]&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt;</span>
<span class="sd">       &lt;tr&gt; &lt;th&gt;?6&lt;/th&gt; &lt;td&gt; &lt;div&gt;&lt;b&gt;c&lt;/b&gt;[|&lt;span&gt;?3&lt;/span&gt;|]&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt;</span>
<span class="sd">       &lt;tr&gt; &lt;th&gt;?7&lt;/th&gt; &lt;td&gt; &lt;div&gt;&lt;b&gt;ac&lt;/b&gt;[|&lt;span&gt;?2&lt;/span&gt;|&lt;span&gt;?6&lt;/span&gt;|]&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt;</span>
<span class="sd">     &lt;/tbody&gt;</span>
<span class="sd">   &lt;/table&gt;</span>

<span class="sd">which displays roughly as:</span>

<span class="sd">   +----+----------------------+</span>
<span class="sd">   | **abc**\[\|?1\|?5\|?7\|\] |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">   | ?1 | **ab**\[\|?2\|?4\|\] |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">   | ?2 | **a**\[\|?3\|\]      |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">   | ?3 | \[\|\]               |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">   | ?4 | **b**\[\|?3\|\]      |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">   | ?5 | **bc**\[\|?4\|?6\|\] |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">   | ?6 | **c**\[\|?3\|\]      |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">   | ?7 | **ac**\[\|?2\|?6\|\] |</span>
<span class="sd">   +----+----------------------+</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">_html_style</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">#toplevel { border-collapse: collapse; }</span>
<span class="s1">#toplevel &gt; thead &gt; tr &gt; td, #toplevel &gt; tbody &gt; tr &gt; td { border: thin solid; text-align:left; }</span>
<span class="s1">#toplevel &gt; thead &gt; tr { border-bottom: thick solid; }</span>
<span class="s1">#toplevel &gt; thead &gt; tr &gt; td &gt; div, #toplevel &gt; tbody &gt; tr &gt; td &gt; div { padding:0; max-height: 5cm; overflow-y: auto; }</span>
<span class="s1">#toplevel span.pointer { padding: 0; color: cyan; background-color: gray; font-weight:bold; }</span>
<span class="s1">&#39;&#39;&#39;</span>
  <span class="n">_html_limit</span> <span class="o">=</span> <span class="mi">50</span>
  <span class="k">class</span> <span class="nc">Pointer</span><span class="p">:</span>
    <span class="n">_slots__</span> <span class="o">=</span> <span class="s1">&#39;element&#39;</span><span class="p">,</span> <span class="s1">&#39;element_&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
      <span class="kn">from</span> <span class="nn">lxml.html.builder</span> <span class="kn">import</span> <span class="n">E</span>
      <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span>
      <span class="n">tref</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;document.getElementById(</span><span class="se">\&#39;</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">).rows[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">]&#39;</span>
      <span class="bp">cls</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;pointer&#39;</span><span class="p">}</span>
      <span class="n">cls_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">onmouseenter</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tref</span><span class="si">}</span><span class="s1">.style.outline=</span><span class="se">\&#39;</span><span class="s1">thin solid red</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">onmouseleave</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tref</span><span class="si">}</span><span class="s1">.style.outline=</span><span class="se">\&#39;\&#39;</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">onclick</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tref</span><span class="si">}</span><span class="s1">.scrollIntoView()&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">E</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">cls</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">element_</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">E</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">cls_</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">lxml.html.builder</span> <span class="kn">import</span> <span class="n">E</span>
    <span class="kn">from</span> <span class="nn">lxml.html</span> <span class="kn">import</span> <span class="n">tostring</span>
    <span class="k">def</span> <span class="nf">hformat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="o">*</span><span class="n">L</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_html_style</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">L</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">html</span><span class="p">,</span><span class="n">colspan</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">))),</span><span class="n">E</span><span class="o">.</span><span class="n">tbody</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">element</span><span class="p">()),</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">html</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">L</span><span class="p">)),</span><span class="nb">id</span><span class="o">=</span><span class="n">tid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="n">style</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;#toplevel&#39;</span><span class="p">,</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="n">tid</span><span class="p">),</span><span class="n">scoped</span><span class="o">=</span><span class="s1">&#39;scoped&#39;</span><span class="p">),</span><span class="n">table</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">html</span>
    <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="c1"># for unhashable objects</span>
      <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">HtmlPlugin</span><span class="p">):</span>
          <span class="n">ctx</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
          <span class="n">p</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">as_html</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">element_</span><span class="p">()</span>
    <span class="n">tid</span> <span class="o">=</span> <span class="n">unid</span><span class="p">(</span><span class="s1">&#39;htmlplugin&#39;</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tostring</span><span class="p">(</span><span class="n">hformat</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">ctx</span> <span class="k">else</span> <span class="n">e</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="Expr">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.Expr">[docs]</a>
<span class="k">class</span> <span class="nc">Expr</span> <span class="p">(</span><span class="n">HtmlPlugin</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class implement closed symbolic expressions.</span>

<span class="sd">:param func: the function of the symbolic expression</span>
<span class="sd">:param a: list of positional arguments of the symbolic expression</span>
<span class="sd">:param ka: dictionary of keyword arguments of the symbolic expression</span>

<span class="sd">The triple *func*, *a*, *ka* forms the configuration of the :class:`Expr` instance. Its value is defined as the result of calling function *func* with positional and keyword arguments *a* and *ka*. The value is actually computed only once (and cached), and only when method :meth:`incarnate` is invoked. Subclasses should define automatic triggers of incarnation (see e.g. classes :class:`MapExpr` and :class:`CallExpr`). The incarnation cache can be reset by invoking method :meth:`reset`.</span>

<span class="sd">Initially, a :class:`Expr` instance is mutable, and its configuration can be changed. It becomes immutable (frozen) after any of the following operations: incarnation (even after it is reset), hashing, and pickling. Incarnation is not saved on pickling, hence lost on unpickling, but can of course be restored using method :meth:`incarnate`. Thus, when receiving a foreign :class:`Expr` instance, a process can decide whether it wants to access its value or only inspect its configuration. If recomputing the value is costly, use a persistent cache for *func*.</span>

<span class="sd">Caveat: function *func* should be defined at the top-level of its module, and the values in *a* and *ka* should be deterministically picklable and hashable (in particular: no dicts nor lists). Hence, any :class:`Expr` instance is itself deterministically picklable and hashable, and can thus be used as argument in the configuration of another :class:`Expr` instance.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

  <span class="n">incarnated</span><span class="p">:</span> <span class="nb">bool</span>
  <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">func</span><span class="p">:</span><span class="n">Callable</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Expr.rearg">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.Expr.rearg">[docs]</a>
  <span class="k">def</span> <span class="nf">rearg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Updates the config arguments of this instance: *a* is appended to the list of positional arguments and *ka* is updated into the dictionary of keyword arguments. Raises an error if the instance is frozen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;attempt to update a frozen Expr instance&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span></div>


<div class="viewcode-block" id="Expr.refunc">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.Expr.refunc">[docs]</a>
  <span class="k">def</span> <span class="nf">refunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">:</span><span class="n">Callable</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Set *f* as the config function of this instance. Raises an error if the instance is frozen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;attempt to update a frozen Expr instance&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span></div>


  <span class="k">def</span> <span class="nf">incarnate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incarnated</span><span class="p">:</span> <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">incarnated</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
    <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">incarnated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">k</span>

  <span class="k">def</span> <span class="nf">as_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">lxml.html.builder</span> <span class="kn">import</span> <span class="n">E</span>
    <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="n">opn</span><span class="p">,</span><span class="n">clo</span> <span class="o">=</span> <span class="p">((</span><span class="n">E</span><span class="o">.</span><span class="n">span</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incarnated</span> <span class="k">else</span> <span class="n">E</span><span class="o">.</span><span class="n">em</span><span class="p">)(</span><span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;padding:5px;&#39;</span><span class="p">),</span><span class="n">E</span><span class="o">.</span><span class="n">b</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">),),</span> <span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">b</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">),)</span>
    <span class="k">return</span> <span class="n">html_parlist</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span><span class="n">opening</span><span class="o">=</span><span class="n">opn</span><span class="p">,</span><span class="n">closing</span><span class="o">=</span><span class="n">clo</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="nb">dict</span><span class="p">(</span><span class="n">ka</span><span class="p">)]</span>
  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">())</span>
  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">Expr</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">config</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incarnated</span><span class="p">:</span> <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">and</span> <span class="n">ka</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">ka</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">a</span><span class="si">}{</span><span class="n">sep</span><span class="si">}{</span><span class="n">ka</span><span class="si">}</span><span class="s1">)&#39;</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MapExpr">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.MapExpr">[docs]</a>
<span class="k">class</span> <span class="nc">MapExpr</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Symbolic expressions of this class are also (read-only) mappings and trigger incarnation on all the mapping operations, then delegate such operations to their value (expected to be a mapping).</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">incarnate</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">incarnate</span><span class="p">();</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">incarnate</span><span class="p">();</span> <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="CallExpr">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.CallExpr">[docs]</a>
<span class="k">class</span> <span class="nc">CallExpr</span> <span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Symbolic expressions of this class are also callables, and trigger incarnation on invocation, then delegate the invocation to their value (expected to be a callable).</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">incarnate</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="html_parlist">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.html_parlist">[docs]</a>
<span class="k">def</span> <span class="nf">html_parlist</span><span class="p">(</span>
  <span class="n">html</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span><span class="n">La</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span><span class="n">Lka</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span>
  <span class="n">opening</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">Element</span><span class="p">]</span><span class="o">=</span><span class="p">(),</span><span class="n">closing</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">Element</span><span class="p">]</span><span class="o">=</span><span class="p">(),</span><span class="n">style</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;padding: 5px&#39;</span>
  <span class="p">)</span><span class="o">-&gt;</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">HtmlElement</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param html: callable to use on components to get their HTML representation</span>
<span class="sd">:param La: anonymous components</span>
<span class="sd">:param Lka: named components</span>
<span class="sd">:param opening: lists of HTML elements used as prolog</span>
<span class="sd">:param closing: lists of HTML elements used as epilog</span>

<span class="sd">Returns a default HTML representation of a compound object, where *La,Lka* are the lists of unnamed and named components.The representation consists of the HTML elements in *opening* followed by the representation of the components in *La* and *Lka* (the latter are prefixed with their names in bold), followed by the HTML elements in *closing*.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">lxml.html.builder</span> <span class="kn">import</span> <span class="n">E</span>
  <span class="k">def</span> <span class="nf">content</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">La</span><span class="p">:</span> <span class="k">yield</span> <span class="n">E</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">html</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">Lka</span><span class="p">:</span> <span class="k">yield</span> <span class="n">E</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">b</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)),</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="n">html</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="o">*</span><span class="n">opening</span><span class="p">,</span><span class="o">*</span><span class="n">content</span><span class="p">(),</span><span class="o">*</span><span class="n">closing</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;padding:0&#39;</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="html_table">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.html_table">[docs]</a>
<span class="k">def</span> <span class="nf">html_table</span><span class="p">(</span>
    <span class="n">irows</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="o">...</span><span class="p">]]],</span><span class="n">fmts</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="nb">str</span><span class="p">],</span><span class="o">...</span><span class="p">],</span>
    <span class="n">hdrs</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opening</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">closing</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">encoding</span><span class="p">:</span><span class="nb">type</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span>
  <span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="o">|</span><span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">HtmlElement</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param irows: a generator of pairs of an object (key) and a tuple of objects (value)</span>
<span class="sd">:param fmts: a tuple of format functions matching the length of the value tuples</span>
<span class="sd">:param hdrs: a tuple of strings matching the length of the value tuples</span>
<span class="sd">:param opening: lists of HTML elements used as head of table</span>
<span class="sd">:param closing: lists of HTML elements used as foot of table</span>
<span class="sd">:param encoding: encoding of the result</span>

<span class="sd">Returns an HTML table object (as understood by :mod:`lxml`) with one row for each pair generated from *irow*. The key of each pair is in a column of its own with no header, and the value must be a tuple whose length matches the number of columns. The format functions in *fmts*, one for each column, are expected to return HTML objects. *hdrs* may specify headers as a tuple of strings, one for each column. If *encoding* is :const:`None`, the result is returned as an :mod:`lxml.html` object, otherwise it is returned as a string with the specified encoding.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">lxml.html.builder</span> <span class="kn">import</span> <span class="n">E</span>
  <span class="kn">from</span> <span class="nn">lxml.html</span> <span class="kn">import</span> <span class="n">tostring</span>
  <span class="k">def</span> <span class="nf">thead</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">opening</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">yield</span> <span class="n">E</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">opening</span><span class="p">,</span><span class="n">colspan</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fmts</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">hdrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">yield</span> <span class="n">E</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(),</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">th</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">hdrs</span><span class="p">))</span>
  <span class="k">def</span> <span class="nf">tbody</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">irows</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">E</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">th</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">fmt</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fmts</span><span class="p">,</span><span class="n">row</span><span class="p">)))</span>
  <span class="k">def</span> <span class="nf">tfoot</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">closing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">yield</span> <span class="n">E</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(),</span><span class="n">E</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">closing</span><span class="p">,</span><span class="n">colspan</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fmts</span><span class="p">))))</span>
  <span class="n">tid</span> <span class="o">=</span> <span class="n">unid</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="n">html_table</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;#toplevel&#39;</span><span class="p">,</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="n">tid</span><span class="p">),</span><span class="n">scoped</span><span class="o">=</span><span class="s1">&#39;scoped&#39;</span><span class="p">),</span><span class="n">E</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="o">*</span><span class="n">thead</span><span class="p">()),</span><span class="n">E</span><span class="o">.</span><span class="n">tbody</span><span class="p">(</span><span class="o">*</span><span class="n">tbody</span><span class="p">()),</span><span class="n">E</span><span class="o">.</span><span class="n">tfoot</span><span class="p">(</span><span class="o">*</span><span class="n">tfoot</span><span class="p">()),</span><span class="nb">id</span><span class="o">=</span><span class="n">tid</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">t</span> <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tostring</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span></div>


<span class="n">html_table</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  #toplevel { border-collapse: collapse; }</span>
<span class="s1">  #toplevel &gt; thead &gt; tr &gt; th, #toplevel &gt; thead &gt; tr &gt; td, #toplevel &gt; tbody &gt; tr &gt; th, #toplevel &gt; tbody &gt; tr &gt; td, #toplevel &gt; tfoot &gt; tr &gt; td  { background-color: white; color:black; text-align: left; vertical-align: top; border: thin solid black; }</span>
<span class="s1">  #toplevel &gt; thead &gt; tr &gt; th, #toplevel &gt; thead &gt; tr &gt; td { background-color: gray; color: white }</span>
<span class="s1">  #toplevel &gt; tfoot &gt; tr &gt; td { background-color: #f0f0f0; color: navy; }</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="html_stack">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.html_stack">[docs]</a>
<span class="k">def</span> <span class="nf">html_stack</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param a: a list of (lists of) HTML objects (as understood by :mod:`lxml.html`)</span>
<span class="sd">:param ka: a dictionary of HTML attributes for the DIV encapsulating each object</span>

<span class="sd">Merges the list of HTML objects into a single HTML object, which is returned.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">lxml.html.builder</span> <span class="kn">import</span> <span class="n">E</span>
  <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">))</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="SQliteStack">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.SQliteStack">[docs]</a>
<span class="k">class</span> <span class="nc">SQliteStack</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Objects of this class are aggregation functions which simply collect results in a list, for use with a SQlite database. Example::</span>

<span class="sd">   with sqlite3.connect(&#39;/path/to/db&#39;) as conn:</span>
<span class="sd">     rstack = SQliteStack.setup(conn,&#39;stack&#39;,2)</span>
<span class="sd">     for school,x in conn.execute(&#39;SELECT school,stack(age,height) FROM PupilsTable GROUP BY school&#39;):</span>
<span class="sd">       print(school,rstack(x))</span>

<span class="sd">prints pairs *school*, *L* where *L* is a list of pairs *age*, *height*.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">contents</span><span class="p">:</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">;</span> <span class="k">return</span> <span class="n">n</span>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">create_aggregate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">SQliteStack</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SQliteStack</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">pop</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="SQliteNew">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.SQliteNew">[docs]</a>
<span class="k">def</span> <span class="nf">SQliteNew</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">schema</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param path: a path to an sqlite database</span>
<span class="sd">:param schema: the schema specification</span>

<span class="sd">Makes sure the file at *path* is a SQlite3 database with schema exactly equal to *schema*.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">import</span> <span class="nn">sqlite3</span>
  <span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">whitespace</span>
  <span class="n">sep</span> <span class="o">=</span> <span class="n">whitespace</span><span class="o">+</span><span class="s1">&#39;;&#39;</span>
  <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">isolation_level</span><span class="o">=</span><span class="s1">&#39;EXCLUSIVE&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">[</span><span class="n">sql</span> <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT sql FROM sqlite_master WHERE name NOT LIKE </span><span class="se">\&#39;</span><span class="s1">sqlite%</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">S</span><span class="p">:</span>
      <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;database has a version conflict&#39;</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sql</span><span class="p">):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">sep</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;database has a version conflict&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">conn</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="gitcheck">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.gitcheck">[docs]</a>
<span class="k">def</span> <span class="nf">gitcheck</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">update</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param path: a path to a git repository</span>
<span class="sd">:param update: whether to update if stale</span>

<span class="sd">Checks directory at *path*, assumed to be a git repository. If *update* is true, attempts to synch with its origin. Returns a tuple of the status  (a string) followed by a list of details. The details are fields ``ref``, ``flags`` and ``note`` from the :class:`git.remote.FetchInfo` object returned by the pull operation. Status is</span>

<span class="sd">* ``dirty``: repository is dirty (no details)</span>
<span class="sd">* ``uptodate``: repository is up to date (details only if remote exists)</span>
<span class="sd">* ``uptodate-now``: repository was stale but has been successfully updated (when *update* is :const:`True`)</span>
<span class="sd">* ``stale``: repository is stale but has not been touched (when *update* is :const:`False`)</span>

<span class="sd">Use the ``GIT_PYTHON_GIT_EXECUTABLE`` environment variable to set the Git executable if it is not the default ``/usr/bin/git``.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="n">Repo</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">():</span> <span class="k">return</span> <span class="s1">&#39;dirty&#39;</span><span class="p">,</span>
  <span class="k">try</span><span class="p">:</span> <span class="n">rm</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;uptodate&#39;</span><span class="p">,</span> <span class="c1"># clean and no remote</span>
  <span class="n">i</span><span class="p">,</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="n">dry_run</span><span class="o">=</span><span class="ow">not</span> <span class="n">update</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ref</span><span class="p">),</span><span class="n">i</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">note</span> <span class="c1"># detail</span>
  <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">i</span><span class="o">.</span><span class="n">HEAD_UPTODATE</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;uptodate&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">d</span>
  <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">commit</span><span class="o">!=</span><span class="n">r</span><span class="o">.</span><span class="n">commit</span><span class="p">():</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Git synch failed&#39;</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;git pull run on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;uptodate-now&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">d</span>
  <span class="k">return</span> <span class="s1">&#39;stale&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">d</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="gitcheck_package">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.gitcheck_package">[docs]</a>
<span class="k">def</span> <span class="nf">gitcheck_package</span><span class="p">(</span><span class="n">pkgname</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param pkgname: full name of a package</span>
<span class="sd">:param update: whether to update (git pull) if stale</span>

<span class="sd">Assumes that *pkgname* is the name of a python regular (non namespace) package and invokes :meth:`gitcheck` on its path. Reloads the package if ``uptodate-now`` is returned.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">importlib.util</span> <span class="kn">import</span> <span class="n">find_spec</span>
  <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
  <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">modules</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pkg</span><span class="o">:=</span><span class="n">find_spec</span><span class="p">(</span><span class="n">pkgname</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">locs</span><span class="o">:=</span><span class="n">pkg</span><span class="o">.</span><span class="n">submodule_search_locations</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not a regular package&#39;</span><span class="p">,</span><span class="n">pkgname</span><span class="p">)</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">gitcheck</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">update</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;uptodate-now&#39;</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Reloading </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">pkgname</span><span class="p">);</span> <span class="n">reload</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">c</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="SQLinitMetainfoException">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.SQLinitMetainfoException">[docs]</a>
<span class="k">class</span> <span class="nc">SQLinitMetainfoException</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span></div>

<div class="viewcode-block" id="SQLinit">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.SQLinit">[docs]</a>
<span class="k">def</span> <span class="nf">SQLinit</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">Engine</span><span class="p">,</span><span class="n">meta</span><span class="p">:</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">MetaData</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">Engine</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param engine: a sqlalchemy engine (or its url)</span>
<span class="sd">:param meta: a sqlalchemy metadata structure</span>

<span class="sd">* When the database is empty, a ``Metainfo`` table with a single row matching exactly the :attr:`info` attribute of *meta* is created, then the database is populated using *meta*.</span>

<span class="sd">* When the database is not empty, it must contain a ``Metainfo`` table with a single row matching exactly the :attr:`info` attribute of *meta*, otherwise an exception is raised.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
  <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">event</span>
  <span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span> <span class="n">Integer</span>
  <span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">and_</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">driver</span> <span class="o">==</span> <span class="s1">&#39;pysqlite&#39;</span><span class="p">:</span>
    <span class="c1"># fixes a bug in the pysqlite driver; to be removed if fixed</span>
    <span class="c1"># see http://docs.sqlalchemy.org/en/rel_1_0/dialects/sqlite.html</span>
    <span class="k">def</span> <span class="nf">do_connect</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">rec</span><span class="p">):</span> <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">do_begin</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span> <span class="n">conn</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN&#39;</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span><span class="n">do_connect</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span><span class="n">do_begin</span><span class="p">)</span>
  <span class="n">meta_</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
  <span class="n">meta_</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">meta_</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">metainfo_table</span> <span class="o">=</span> <span class="n">meta_</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;Metainfo&#39;</span><span class="p">]</span>
      <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span> <span class="n">metainfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">metainfo_table</span><span class="o">.</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span>
      <span class="k">del</span> <span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="n">SQLinitMetainfoException</span><span class="p">(</span><span class="s1">&#39;Not found&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">metainfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SQLinitMetainfoException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">[expected:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">,found:</span><span class="si">{</span><span class="n">metainfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">metainfo_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
      <span class="s1">&#39;Metainfo&#39;</span><span class="p">,</span><span class="n">meta_</span><span class="p">,</span>
      <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span><span class="n">DateTime</span><span class="p">()),</span>
      <span class="o">*</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">Text</span><span class="p">())</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">meta_</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">metainfo_table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="o">**</span><span class="n">meta</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">engine</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="SQLHandler">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.SQLHandler">[docs]</a>
<span class="k">class</span> <span class="nc">SQLHandler</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param engine: a sqlalchemy engine (or its url)</span>
<span class="sd">:param label: a text label</span>

<span class="sd">A logging handler class which writes the log messages into a database.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">engine</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Engine</span><span class="p">,</span><span class="n">label</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">and_</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">SQLHandlerMetadata</span><span class="p">()</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">SQLinit</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">meta</span><span class="p">)</span>
    <span class="n">session_table</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;Session&#39;</span><span class="p">]</span>
    <span class="n">log_table</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;Log&#39;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;sqlite&#39;</span><span class="p">:</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA foreign_keys = 1&#39;</span><span class="p">)</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">session_table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">session_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="n">label</span><span class="p">))</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">session_table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">started</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
      <span class="n">session</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">dbrecord</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="n">log_table</span><span class="o">=</span><span class="n">log_table</span><span class="p">,</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">):</span>
      <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">log_table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">levelno</span><span class="p">,</span><span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">created</span><span class="p">),</span><span class="n">module</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">module</span><span class="p">,</span><span class="n">funcName</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">funcName</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dbrecord</span> <span class="o">=</span> <span class="n">dbrecord</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>

<div class="viewcode-block" id="SQLHandler.emit">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.SQLHandler.emit">[docs]</a>
  <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rec</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dbrecord</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span></div>
</div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">SQLHandlerMetadata</span><span class="p">(</span><span class="n">info</span><span class="p">:</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;.SQLHandler&#39;</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">MetaData</span><span class="p">:</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">MetaData</span>
  <span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span> <span class="n">Integer</span>
  <span class="n">meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
  <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;Session&#39;</span><span class="p">,</span><span class="n">meta</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;oid&#39;</span><span class="p">,</span><span class="n">Integer</span><span class="p">(),</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;started&#39;</span><span class="p">,</span><span class="n">DateTime</span><span class="p">()),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="n">Text</span><span class="p">(),</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
  <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;Log&#39;</span><span class="p">,</span><span class="n">meta</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;oid&#39;</span><span class="p">,</span><span class="n">Integer</span><span class="p">(),</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">,</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Session.oid&#39;</span><span class="p">,</span><span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="n">Integer</span><span class="p">(),</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span><span class="n">DateTime</span><span class="p">(),</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="n">Text</span><span class="p">(),</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;funcName&#39;</span><span class="p">,</span><span class="n">Text</span><span class="p">(),</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="n">Text</span><span class="p">(),</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
  <span class="k">return</span> <span class="n">meta</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="ormsroot">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.ormsroot">[docs]</a>
<span class="k">class</span> <span class="nc">ormsroot</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">,</span><span class="n">HtmlPlugin</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class implement very simple persistent object managers based on the sqlalchemy ORM. This class should not be instantiated directly.</span>

<span class="sd">Each subclass *C* of this class should define a class attribute :attr:`base` assigned an sqlalchemy declarative persistent class *B*. Once this is done, a specialised session maker can be obtained by invoking class method :meth:`sessionmaker` of class *C*, with the url of an sqlalchemy supported database as first argument, the other arguments being the same as those for :meth:`sqlalchemy.orm.sessionmaker`. This sessionmaker will produce sessions with the following characteristics:</span>

<span class="sd">* they are attached to an sqlalchemy engine at this url (note that engines are reused across multiple sessionmakers with the same url)</span>

<span class="sd">* they have a :attr:`root` attribute, pointing to an instance of *C*, which acts as a mapping where the keys are the primary keys of *B* and the values the corresponding ORM entries. The root object has a convenient ipython HTML representation.</span>

<span class="sd">Class *C* should provide a method to insert new objects in the persistent class *B*, and they will then be reflected in the session root (and made persitent on session commit). Example::</span>

<span class="sd">   from sqlalchemy.ext.declarative import declarative_base; Base = declarative_base()</span>
<span class="sd">   from sqlalchemy import Column, Text, Integer</span>

<span class="sd">   class Entry (Base): # example of sqlalchemy declarative persistent class definition</span>
<span class="sd">     __tablename__ = &#39;Entry&#39;</span>
<span class="sd">     oid = Column(Integer(),primary_key=True)</span>
<span class="sd">     name = Column(Text())</span>
<span class="sd">     age = Column(Integer())</span>
<span class="sd">     def __repr__(self): return &#39;Entry&lt;{0.oid},{0.name},{0.age}&gt;&#39;.format(self)</span>

<span class="sd">   class Root(ormsroot): # manager for class Entry</span>
<span class="sd">     base = Entry</span>

<span class="sd">   sessionmaker = Root.sessionmaker</span>

<span class="sd">Example of use (assuming :func:`sessionmaker` as above has been imported)::</span>

<span class="sd">   Session = sessionmaker(&#39;sqlite://&#39;) # memory db for the example</span>

<span class="sd">   from contextlib import contextmanager</span>
<span class="sd">   @contextmanager</span>
<span class="sd">   def mysession(): # basic sessions as simple block of instructions</span>
<span class="sd">     s = Session(autocommit=True)</span>
<span class="sd">     try: yield s</span>
<span class="sd">     finally: s.close()</span>

<span class="sd">   with mysession() as s: assert len(s.root)==0</span>

<span class="sd">   with mysession() as s:</span>
<span class="sd">     # first session, define two entries. Use key None in assignment because Entry is autokey</span>
<span class="sd">     self.root[None] = Entry(name=&#39;jack&#39;,age=42); self.root[None] = Entry(name=&#39;jill&#39;,age=29)</span>
<span class="sd">     assert len(s.root) == 2 and s.root[1].name==&#39;jack&#39; and s.root[2].name==&#39;jill&#39;</span>

<span class="sd">   with mysession() as s: # second session, possibly on another process (if not memory db)</span>
<span class="sd">     jack = s.root.pop(1) # also removes from db</span>
<span class="sd">     assert len(s.root) == 1 and jack.name==&#39;jack&#39;</span>

<span class="sd">   with mysession() as s: # But of course direct sqlalchemy operations are available</span>
<span class="sd">     assert len(s.root) == 1</span>
<span class="sd">     x, = list(s.query(Entry.name).filter(Entry.age&gt;25))</span>
<span class="sd">   assert x.name == &#39;jill&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

  <span class="n">base</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># must be defined in subclasses, NOT at the instance level</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">session</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">getpk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">,</span><span class="n">kn</span><span class="o">=</span><span class="n">pk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">kn</span><span class="p">)</span>
      <span class="k">def</span> <span class="nf">setpk</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">kn</span><span class="o">=</span><span class="n">pk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="c1"># does nothing if k is None (autokeys)</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">getpk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">,</span><span class="n">kns</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pk</span><span class="p">):</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">kn</span><span class="p">)</span> <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="n">kns</span><span class="p">)</span>
      <span class="k">def</span> <span class="nf">setpk</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">kns</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pk</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">kn</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kns</span><span class="p">,</span><span class="n">ks</span><span class="p">):</span> <span class="n">r</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="c1"># does nothing if ks==() (autokeys)</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getpk</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setpk</span> <span class="o">=</span> <span class="n">getpk</span><span class="p">,</span><span class="n">setpk</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>

  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>

  <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

  <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setpk</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>

  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">):</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpk</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<div class="viewcode-block" id="ormsroot.items">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.ormsroot.items">[docs]</a>
  <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">getpk</span><span class="p">(</span><span class="n">r</span><span class="p">),</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">))</span></div>


  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">as_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_html_limit</span>
    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">();</span> <span class="n">closing</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">L</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_html_limit</span><span class="p">);</span> <span class="n">closing</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> more&#39;</span>
    <span class="k">return</span> <span class="n">html_table</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">k</span><span class="p">,(</span><span class="n">v</span><span class="p">,))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">L</span><span class="p">),</span><span class="n">fmts</span><span class="o">=</span><span class="p">(</span><span class="nb">repr</span><span class="p">,),</span><span class="n">opening</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="n">closing</span><span class="o">=</span><span class="n">closing</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

  <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">sessionmaker</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">url</span><span class="p">,</span><span class="n">execution_options</span><span class="o">=</span><span class="p">{},</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">SQLinit</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="bp">cls</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
      <span class="n">trace</span> <span class="o">=</span> <span class="n">execution_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;trace&#39;</span><span class="p">,{})</span>
      <span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="o">**</span><span class="n">execution_options</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">evt</span><span class="p">,</span><span class="n">log</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span> <span class="n">log</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_lvl</span><span class="o">=</span><span class="n">log</span><span class="p">,</span><span class="n">_fmt</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;SQA:</span><span class="si">{</span><span class="n">evt</span><span class="si">}</span><span class="s1">%s&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">:</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_lvl</span><span class="p">,</span><span class="n">_fmt</span><span class="p">,</span><span class="n">ka</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">evt</span><span class="p">,</span><span class="n">log</span><span class="p">,</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Session_</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">Session</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">):</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">Session_</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span>
      <span class="n">s</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">Session</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="spark">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.spark">[docs]</a>
<span class="k">class</span> <span class="nc">spark</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">If a resource ``spark/pyspark.py`` exists in an XDG configuration file, that resource is executed (locally) and should define a function :func:`init` used as class method :meth:`init` and meant to initialise Spark. The initialisation must assign a :class:`dict` (even an empty one) to attribute :attr:`conf`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">conf</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="spark.display_monitor_link">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.spark.display_monitor_link">[docs]</a>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">display_monitor_link</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">sc</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Displays a link to the monitor of :class:`pyspark.SparkContext` *sc*. Recall that the monitor is active only between the creation of *sc* and its termination (when method :meth:`stop` is invoked).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display_html</span>
    <span class="n">display_html</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;a target=&quot;_blank&quot; href=&quot;</span><span class="si">{</span><span class="n">sc</span><span class="o">.</span><span class="n">uiWebUrl</span><span class="si">}</span><span class="s1">&quot;&gt;SparkMonitor[</span><span class="si">{</span><span class="n">sc</span><span class="o">.</span><span class="n">appName</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">sc</span><span class="o">.</span><span class="n">master</span><span class="si">}</span><span class="s1">]&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="spark.SparkContext">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.spark.SparkContext">[docs]</a>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">SparkContext</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">conf</span><span class="o">=</span><span class="p">{},</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns an instance of :class:`pyspark.SparkContext` created with the predefined configuration held in attribute :attr:`conf` of this class, updated by *conf* (its value must then be a :class:`dict` of :class:`str`). If *debug* is :const:`True`, prints the exact configuration used. If *display* is :const:`True`, displays a link to the monitor of the created context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
    <span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkContext</span><span class="p">,</span> <span class="n">SparkConf</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">SparkConf</span><span class="p">()</span><span class="o">.</span><span class="n">setAll</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="o">.</span><span class="n">setAll</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">toDebugString</span><span class="p">())</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">display</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">display_monitor_link</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sc</span></div>


  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">cls</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="sa">f</span><span class="s1">&#39;Class method </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">.init must assign a str-str dictionary to class attribute </span><span class="se">\&#39;</span><span class="s1">conf</span><span class="se">\&#39;</span><span class="s1">&#39;</span>

  <span class="n">init</span> <span class="o">=</span> <span class="n">config_xdg</span><span class="p">(</span><span class="s1">&#39;spark/pyspark.py&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">init</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">cls</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">D</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">init</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">init</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">])</span>
    <span class="k">del</span> <span class="n">D</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="ImapFolder">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.ImapFolder">[docs]</a>
<span class="k">class</span> <span class="nc">ImapFolder</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class is an iterable enumerating the unread messages in a folder of an IMAP server. On calling method :meth:`commit`, the messages which have been enumerated since the last commit or rollback (triggered by method :meth:`rollback`) are marked as read. The total number of messages in the folder is held in attribute :attr:`total`, and the number of unread message is given by function :func:`len`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1"># ==================================================================================================</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">server</span><span class="p">:</span><span class="s1">&#39;imaplib.IMAP4&#39;</span><span class="p">,</span><span class="n">folder</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">message_from_bytes</span>
    <span class="kn">from</span> <span class="nn">email.message</span> <span class="kn">import</span> <span class="n">EmailMessage</span>
    <span class="kn">from</span> <span class="nn">email.policy</span> <span class="kn">import</span> <span class="n">default</span> <span class="k">as</span> <span class="n">DefaultEmailPolicy</span>
    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="n">t</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="s1">&#39;(RFC822)&#39;</span><span class="p">)</span>
      <span class="k">assert</span> <span class="n">t</span><span class="o">==</span><span class="s1">&#39;OK&#39;</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">message_from_bytes</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">_class</span><span class="o">=</span><span class="n">EmailMessage</span><span class="p">,</span><span class="n">policy</span><span class="o">=</span><span class="n">DefaultEmailPolicy</span><span class="p">)</span>
      <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">x</span>
    <span class="n">t</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">t</span><span class="o">==</span><span class="s1">&#39;OK&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">t</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;UNSEEN&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">t</span><span class="o">==</span><span class="s1">&#39;OK&#39;</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">content_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">)</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">():</span>
      <span class="n">server</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seen</span><span class="p">),</span><span class="s1">&#39;+FLAGS&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\Seen&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">content_len</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span>
      <span class="n">seen</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">commit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">clear</span>
  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_len</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="basic_stats">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.basic_stats">[docs]</a>
<span class="k">class</span> <span class="nc">basic_stats</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class maintain basic statistics about a group of values.</span>

<span class="sd">:param weight: total weight of the group</span>
<span class="sd">:param avg: weighted average of the group</span>
<span class="sd">:param var: weighted variance of the group</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weight</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="nb">complex</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span><span class="n">avg</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="nb">complex</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">var</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="nb">complex</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="n">avg</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>
  <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">w</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">var</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">basic_stats</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">other</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">+</span><span class="n">w</span><span class="p">;</span> <span class="n">r_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">/</span><span class="n">W</span><span class="p">;</span> <span class="n">r_other</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="n">W</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">avg</span>
    <span class="k">return</span> <span class="n">basic_stats</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">W</span><span class="p">,</span><span class="n">avg</span><span class="o">=</span><span class="n">r_self</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">avg</span><span class="o">+</span><span class="n">r_other</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">r_self</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">+</span><span class="n">r_other</span><span class="o">*</span><span class="n">v</span><span class="o">+</span><span class="p">(</span><span class="n">r_self</span><span class="o">*</span><span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">r_other</span><span class="o">*</span><span class="n">d</span><span class="p">))</span>
  <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">w</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">var</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">basic_stats</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">other</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">+=</span> <span class="n">w</span><span class="p">;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">avg</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">+=</span> <span class="n">r</span><span class="o">*</span><span class="n">d</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">+=</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;basic_stats&lt;weight:</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="si">}</span><span class="s1">,avg:</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span><span class="si">}</span><span class="s1">,var:</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="iso2date">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.iso2date">[docs]</a>
<span class="k">def</span> <span class="nf">iso2date</span><span class="p">(</span><span class="n">iso</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">])</span><span class="o">-&gt;</span><span class="s1">&#39;datetime.date&#39;</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param iso: triple as returned by :meth:`datetime.date.isocalendar`</span>

<span class="sd">Returns the :class:`datetime.date` instance for which the :meth:`datetime.date.isocalendar` method returns *iso*::</span>

<span class="sd">   from datetime import datetime</span>
<span class="sd">   d = datetime.now().date(); assert iso2date(d.isocalendar()) == d</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span><span class="n">timedelta</span>
  <span class="n">isoyear</span><span class="p">,</span><span class="n">isoweek</span><span class="p">,</span><span class="n">isoday</span> <span class="o">=</span> <span class="n">iso</span>
  <span class="n">jan4</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">isoyear</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
  <span class="n">iso1</span> <span class="o">=</span> <span class="n">jan4</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">jan4</span><span class="o">.</span><span class="n">weekday</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">iso1</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">isoday</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">weeks</span><span class="o">=</span><span class="n">isoweek</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="size_fmt">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.size_fmt">[docs]</a>
<span class="k">def</span> <span class="nf">size_fmt</span><span class="p">(</span><span class="n">size</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="p">,</span><span class="n">binary</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">precision</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">suffix</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param size: a positive number representing a size</span>
<span class="sd">:param binary: whether to use IEC binary or decimal convention</span>
<span class="sd">:param precision: number of digits displayed (at least 4)</span>

<span class="sd">Returns the representation of *size* with IEC prefix. Each prefix is *K* times the previous one for some constant *K* which depends on the convention: *K* =1024 with the binary convention (marked with an ``i`` after the prefix); *K* =1000 with the decimal convention. Example::</span>

<span class="sd">   print(size_fmt(2**30), size_fmt(5300), size_fmt(5300,binary=False), size_fmt(42897.3,binary=False,suffix=&#39;m&#39;))</span>
<span class="sd">   #&gt; 1GiB 5.176KiB 5.3KB 42.9Km</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">thr</span><span class="p">,</span><span class="n">mark</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1024.</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">binary</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1000.</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">size</span><span class="o">&lt;</span><span class="n">thr</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span>
  <span class="n">fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">:.</span><span class="si">{</span><span class="n">precision</span><span class="si">}</span><span class="s1">g</span><span class="se">}}{{}}</span><span class="si">{</span><span class="n">mark</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
  <span class="n">size_</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="n">size</span><span class="o">/</span><span class="n">thr</span>
  <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="s1">&#39;KMGTPEZ&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">size_</span> <span class="o">&lt;</span> <span class="n">thr</span><span class="p">:</span> <span class="k">return</span> <span class="n">fmt</span><span class="p">(</span><span class="n">size_</span><span class="p">,</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">size_</span> <span class="o">/=</span> <span class="n">thr</span>
  <span class="k">return</span> <span class="n">fmt</span><span class="p">(</span><span class="n">size_</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span> <span class="c1"># :-)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="time_fmt">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.time_fmt">[docs]</a>
<span class="k">def</span> <span class="nf">time_fmt</span><span class="p">(</span><span class="n">time</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="p">,</span><span class="n">precision</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param time: a number representing a time in seconds</span>
<span class="sd">:param precision: number of digits displayed</span>

<span class="sd">Returns the representation of *time* in one of days,hours,minutes,seconds,milli-seconds (depending on magnitude). Example::</span>

<span class="sd">   print(time_fmt(100000,4),time_fmt(4238.45),time_fmt(5.35,0),time_fmt(.932476))</span>
<span class="sd">   #&gt; 1.1574day 1.18hr 5sec 932msec</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">:.</span><span class="si">{</span><span class="n">precision</span><span class="si">}</span><span class="s1">f</span><span class="se">}}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
  <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time</span><span class="si">:</span><span class="s1">3.3g</span><span class="si">}</span><span class="s1">msec&#39;</span>
  <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mf">60.</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fmt</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s1">sec&#39;</span>
  <span class="n">time_</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="n">time</span><span class="o">/</span><span class="mf">60.</span>
  <span class="k">if</span> <span class="n">time_</span> <span class="o">&lt;</span> <span class="mf">60.</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fmt</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span><span class="si">}</span><span class="s1">min&#39;</span>
  <span class="n">time_</span> <span class="o">/=</span> <span class="mf">60.</span>
  <span class="k">if</span> <span class="n">time_</span> <span class="o">&lt;</span> <span class="mf">24.</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fmt</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span><span class="si">}</span><span class="s1">hr&#39;</span>
  <span class="n">time_</span> <span class="o">/=</span> <span class="mf">24.</span>
  <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fmt</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span><span class="si">}</span><span class="s1">day&#39;</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="versioned">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.versioned">[docs]</a>
<span class="k">def</span> <span class="nf">versioned</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">],</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A decorator which assigns attribute :attr:`version` of the target function to *v*. The function must be defined at the toplevel of its module. The version must be a simple value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">f</span><span class="p">:</span><span class="n">Callable</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isfunction</span>
    <span class="k">assert</span> <span class="n">isfunction</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="k">return</span> <span class="n">f</span>
  <span class="k">return</span> <span class="n">transform</span></div>


<span class="c1">#==================================================================================================</span>
<span class="c1"># Utilities</span>
<span class="c1">#==================================================================================================</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="unid">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.unid">[docs]</a>
<span class="k">def</span> <span class="nf">unid</span><span class="p">(</span><span class="n">post</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">pre</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="vm">__name__</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns a &quot;unique&quot; id for miscellanous uses.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">pre</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span><span class="o">+</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="printast">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.printast">[docs]</a>
<span class="k">def</span> <span class="nf">printast</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param x: an AST or string (parsed into an AST)</span>

<span class="sd">Pretty-prints the AST object (python abstract syntax tree).</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="kn">import</span> <span class="nn">ast</span>
  <span class="k">def</span> <span class="nf">pp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pre</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">indent</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">pre</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
      <span class="n">indent</span> <span class="o">+=</span> <span class="s1">&#39; | &#39;</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">iter_fields</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">pp</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">indent</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">pp</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s1">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">pre</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
  <span class="n">pp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="pickleclass">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.pickleclass">[docs]</a>
<span class="k">class</span> <span class="nc">pickleclass</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This namespace class defines class methods :meth:`load`, :meth:`loads`, :meth:`dump`, :meth:`dumps`, similar to those of the standard :mod:`pickle` module, but with class specific Pickler/Unpickler which must be defined in subclasses.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

  <span class="n">Pickler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="n">pickle</span><span class="o">.</span><span class="n">Pickler</span><span class="p">]</span>
  <span class="n">Unpickler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="n">pickle</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">]</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="n">v</span><span class="p">):</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Pickler</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">u</span><span class="p">):</span> <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Pickler</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="k">with</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span> <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="einsum_nd">
<a class="viewcode-back" href="../mod_init.html#PYTOOLS.einsum_nd">[docs]</a>
<span class="k">def</span> <span class="nf">einsum_nd</span><span class="p">(</span><span class="n">sgn</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">pat</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)\.?&#39;</span><span class="p">)):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Equivalent of numpy.einsum with named dimensions (limited to 26 like the original!). Dimension names must be words in the sense of the :mod:`re` module (unicode allowed) and must be separated by &#39;.&#39; in operand shapes.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">einsum</span>
  <span class="n">D</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span> <span class="n">A</span><span class="o">=</span><span class="nb">iter</span><span class="p">(</span><span class="s1">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span class="p">):</span> <span class="nb">next</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">einsum</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">sub</span><span class="p">((</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span><span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">:</span><span class="n">D</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span><span class="n">sgn</span><span class="p">),</span><span class="o">*</span><span class="n">a</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Jean-Marc Andreoli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>