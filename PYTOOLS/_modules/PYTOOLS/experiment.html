<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PYTOOLS.experiment &mdash; PYTOOLS  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PYTOOLS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mod_init.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS</span></code> (top level) — Generic utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_torch.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.torch</span></code> — Utilities for pytorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_animation.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.animation</span></code> — Animation utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_cache.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.cache</span></code> — A persistent cache mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_ipywidgets.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.ipywidgets</span></code> — Widget utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_polling.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.polling</span></code> — Generic polling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_simpy.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.simpy</span></code> — Utilities for simpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_experiment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.experiment</span></code> — Utilities for pytorch experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_tensorboard_manager.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.tensorboard_manager</span></code> — A server of tensorboard servers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PYTOOLS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../PYTOOLS.html">PYTOOLS</a></li>
      <li class="breadcrumb-item active">PYTOOLS.experiment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for PYTOOLS.experiment</h1><div class="highlight"><pre>
<span></span><span class="c1"># File:                 experiment.py</span>
<span class="c1"># Creation date:        2020-01-15</span>
<span class="c1"># Contributors:         Jean-Marc Andreoli</span>
<span class="c1"># Language:             python</span>
<span class="c1"># Purpose:              Some utilities for pytorch experiments</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span>
<span class="kn">import</span> <span class="nn">logging</span><span class="p">;</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">zip_longest</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">ctime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pydispatch</span> <span class="kn">import</span> <span class="n">Dispatcher</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fmtwrap</span><span class="p">,</span> <span class="n">time_fmt</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="udict">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.udict">[docs]</a>
<span class="k">class</span> <span class="nc">udict</span> <span class="p">(</span><span class="nb">dict</span><span class="p">):</span> <span class="c1"># a utility class reflecting a dictionary as an object (attributes=keys); must be at the top</span>
<span class="c1">#==================================================================================================</span>
  <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
  <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span> <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
  <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">v</span><span class="p">):</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="ProcessInfo">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.ProcessInfo">[docs]</a>
<span class="k">class</span> <span class="nc">ProcessInfo</span> <span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">origin</span><span class="p">:</span> <span class="n">OriginInfo</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Origin of a run&quot;&quot;&quot;</span>
  <span class="n">host</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Host from which the run is invoked&quot;&quot;&quot;</span>
  <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Process from which the run is invoked&quot;&quot;&quot;</span>
  <span class="n">started</span><span class="p">:</span> <span class="n">datetime</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Date-time of a run invocation&quot;&quot;&quot;</span></div>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="OriginInfo">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.OriginInfo">[docs]</a>
<span class="k">class</span> <span class="nc">OriginInfo</span> <span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">path</span><span class="p">:</span> <span class="n">Path</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;File path from which the run was initialised&quot;&quot;&quot;</span>
  <span class="n">mtime</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Last modified time of that file&quot;&quot;&quot;</span>
  <span class="n">walltime</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Walltime instant of the run when it was saved to that file&quot;&quot;&quot;</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="Monitor">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Monitor">[docs]</a>
<span class="k">class</span> <span class="nc">Monitor</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class controls a run. It can</span>

<span class="sd">* initialise the run from scratch or from a previous checkpoint</span>
<span class="sd">* attempt to save a checkpoint at regular time intervals</span>
<span class="sd">* update the run&#39;s progress</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checkpoint path&quot;&quot;&quot;</span>
  <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Minimum time interval (in sec) between a successful checkpoint and its next checkpoint attempt&quot;&quot;&quot;</span>
  <span class="n">penalty</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Multiplicative coefficient applied to the last interval when the last checkpoint attempt failed&quot;&quot;&quot;</span>
  <span class="n">progress</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">float</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Progress indicator (return value must be between 0. and 1.)&quot;&quot;&quot;</span>
  <span class="n">temporary</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span><span class="n">IO</span><span class="p">]</span> <span class="c1"># helper function to open a temporary path to save checkpoints</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="o">|</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">interval</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span><span class="n">penalty</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">progress</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">:</span> <span class="mf">0.</span><span class="p">)):</span>
    <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">temporary</span> <span class="o">=</span> <span class="n">f</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">NamedTemporaryFile</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
      <span class="k">with</span> <span class="n">f</span><span class="p">():</span> <span class="k">pass</span> <span class="c1"># checks access rights</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">penalty</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span><span class="n">interval</span><span class="p">,</span><span class="n">penalty</span><span class="p">,</span><span class="n">progress</span>

<div class="viewcode-block" id="Monitor.checkpoint">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Monitor.checkpoint">[docs]</a>
  <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">:</span><span class="n">Run</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Attempts to checkpoint *run* at regular interval.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">dill</span> <span class="kn">import</span> <span class="n">dump</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">:=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">walltime</span><span class="p">();</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="o">&gt;=</span><span class="n">run</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span> <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">t</span><span class="o">-</span><span class="n">run</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="k">if</span> <span class="n">l</span><span class="o">&lt;=</span><span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">penalty</span><span class="o">**</span><span class="n">l</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># checkpointing attempt</span>
          <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span> <span class="n">dump</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">run</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()),</span><span class="n">v</span><span class="p">)</span>
          <span class="c1"># if a hard crash occurs in the next 2 lines, a manual recovery is still possible</span>
          <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="n">Path</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span> <span class="n">run</span><span class="o">.</span><span class="n">checkpoint</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">exc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">run</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">run</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">,</span><span class="n">run</span><span class="p">)</span></div>


<div class="viewcode-block" id="Monitor.initial">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Monitor.initial">[docs]</a>
  <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">:</span><span class="n">Run</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialises *run* either from scratch or from a checkpoint.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">getfqdn</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getpid</span>
    <span class="kn">from</span> <span class="nn">dill</span> <span class="kn">import</span> <span class="n">load</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">:=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="c1"># from checkpoint</span>
      <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span><span class="n">D</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
      <span class="n">run</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">D</span><span class="p">);</span> <span class="n">run</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="p">,</span><span class="kc">None</span><span class="p">)]</span>
      <span class="n">origin</span> <span class="o">=</span> <span class="n">OriginInfo</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span><span class="n">mtime</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span><span class="n">walltime</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># from scratch</span>
      <span class="n">run</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="n">run</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">origin</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">run</span><span class="o">.</span><span class="n">process_info</span> <span class="o">=</span> <span class="n">ProcessInfo</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="n">getfqdn</span><span class="p">(),</span><span class="n">pid</span><span class="o">=</span><span class="n">getpid</span><span class="p">(),</span><span class="n">started</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">run</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span><span class="p">:</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="Run">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run">[docs]</a>
<span class="k">class</span> <span class="nc">Run</span> <span class="p">(</span><span class="n">Dispatcher</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class is a callable, taking no argument and returning no value. The execution of a run only changes its attribute values. All the keyword arguments of the constructor are passed to method :meth:`setup`.</span>

<span class="sd">Runs may emit messages during their execution. Callbacks attached to each message are passed a single argument, which is the run itself. Listeners (instances of class :class:`RunListener`) define sets of consistent callbacks. A run can invoke a method :meth:`add&lt;name&gt;Listener` to attach a listener of type `&lt;name&gt;` to itself. Some such methods are defined in class :class:`Run` and its subclasses (see their documentation for details).</span>

<span class="sd">A typical event callback stores the result of a campaign of measures on the run. Measures (instances of class :class:`Measure`) are in charge of reporting individual measures. A run can invoke a method :meth:`add&lt;name&gt;Measure` to attach a measure of type `&lt;name&gt;` to itself. Some such methods are defined in class :class:`Run` and its subclasses (see their documentation for details). In particular, all the pytorch losses can be added in this way.</span>

<span class="sd">Attributes (\*) must be explicitly instantiated at creation time.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

  <span class="n">_events_</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;start_step&#39;</span><span class="p">,</span><span class="s1">&#39;end_step&#39;</span><span class="p">,</span><span class="s1">&#39;start_epoch&#39;</span><span class="p">,</span><span class="s1">&#39;end_epoch&#39;</span><span class="p">,</span><span class="s1">&#39;checkpoint&#39;</span>

  <span class="c1">## set at instantiation</span>
  <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="o">|</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)The device on which to run the model&quot;&quot;&quot;</span>
  <span class="n">net</span><span class="p">:</span> <span class="n">Net</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)The model (initially on cpu, but loaded on :attr:`device` at the beginning of the run and restored to cpu at the end)&quot;&quot;&quot;</span>
  <span class="n">train_split</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)Iterable of batches. Each batch is a tuple of input tensors (first dim = size of batch)&quot;&quot;&quot;</span>
  <span class="n">valid_split</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)Same format as :attr:`train_data`&quot;&quot;&quot;</span>
  <span class="n">test_split</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)Same format as :attr:`train_data`&quot;&quot;&quot;</span>
  <span class="n">optimiser_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]],</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)The optimiser factory&quot;&quot;&quot;</span>
  <span class="n">monitor</span><span class="p">:</span> <span class="n">Monitor</span> <span class="o">=</span> <span class="n">Monitor</span><span class="p">()</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)The monitor of the run, in charge of checkpoints and progress control&quot;&quot;&quot;</span>
  <span class="n">listeners</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">RunListener</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Named listener objects&quot;&quot;&quot;</span>
  <span class="n">measures</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Accumulator</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Named measure objects&quot;&quot;&quot;</span>
  <span class="c1">## set at execution</span>
  <span class="n">optimiser</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The optimiser&quot;&quot;&quot;</span>
  <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Number of optimiser updates&quot;&quot;&quot;</span>
  <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Number of passes through the data&quot;&quot;&quot;</span>
  <span class="n">loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Last step loss, if any&quot;&quot;&quot;</span>
  <span class="n">walltime</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span><span class="nb">float</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Wall time elapsed (in sec) since real start of run, set by monitor&quot;&quot;&quot;</span>
  <span class="n">progress</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Progress as a number between 0. and 1., set by monitor&quot;&quot;&quot;</span>
  <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="mf">1.e-9</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Threshold on progress to stop the run&quot;&quot;&quot;</span>
  <span class="n">checkpoint</span><span class="p">:</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checkpoint history, set by monitor&quot;&quot;&quot;</span>
  <span class="n">r_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Running number of optimiser updates in current data pass&quot;&quot;&quot;</span>
  <span class="n">r_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Running loss average in current data pass&quot;&quot;&quot;</span>
  <span class="n">eval_valid</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">float</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function returning the validation performance at the end of the last completed step (cached)&quot;&quot;&quot;</span>
  <span class="n">eval_test</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">float</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function returning the test performance at the end of the last completed step (cached)&quot;&quot;&quot;</span>
  <span class="n">process_info</span><span class="p">:</span> <span class="n">ProcessInfo</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Information about the run&quot;&quot;&quot;</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">fmtwrap</span><span class="p">({})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span> <span class="o">=</span> <span class="n">udict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">measures</span> <span class="o">=</span> <span class="n">udict</span><span class="p">()</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Run.main">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run.main">[docs]</a>
  <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Executes the run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimiser</span> <span class="o">=</span> <span class="n">optimiser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimiser_factory</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eval_valid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_test</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_cache</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_split</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">test_split</span><span class="p">))</span>
    <span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">training</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="kc">True</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_loss</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span> <span class="c1"># iteration = epoch</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;start_epoch&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_split</span><span class="p">:</span> <span class="c1"># iteration = step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;start_step&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">to</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># one batch</span>
            <span class="n">optimiser</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimiser</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">inputs</span> <span class="c1"># free memory before emitting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r_loss</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">r_loss</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">r_step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;end_step&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_loss</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_step</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;end_epoch&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
      <span class="k">finally</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
      <span class="s1">&#39;optimiser&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimiser</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
      <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
      <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
      <span class="s1">&#39;listeners&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="p">}</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">D</span><span class="p">:</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimiser</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="s1">&#39;optimiser&#39;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="s1">&#39;listeners&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Run.checkpoint_status">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run.checkpoint_status">[docs]</a>
  <span class="k">def</span> <span class="nf">checkpoint_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns information about the (error) status of checkpointing attempts.&quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;nerr&#39;</span><span class="p">:</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">}</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Run.eval">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run.eval">[docs]</a>
  <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span><span class="o">...</span><span class="p">]]])</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Evaluates the embedding part of model :attr:`net` on *data* according to :attr:`measures`. With measures aggregated by mean (default), the batches may not be constant-sized.</span>

<span class="sd">:param data: a list of data entries</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">acs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span>
    <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">acs</span><span class="p">:</span> <span class="n">ac</span><span class="o">.</span><span class="n">ini</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">training</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="kc">False</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">to</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">acs</span><span class="p">:</span> <span class="n">ac</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="p">,(</span><span class="n">ac</span><span class="o">.</span><span class="n">val</span><span class="p">()</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">acs</span><span class="p">)))</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Run.eval_cache">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run.eval_cache">[docs]</a>
  <span class="k">def</span> <span class="nf">eval_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a cached version of :meth:`eval` on *data*. The cache is cleared at each step.&quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">cache</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">float</span><span class="p">]:</span>
      <span class="k">nonlocal</span> <span class="n">current</span>
      <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">:</span> <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span>
      <span class="k">return</span> <span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cache</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Run.measure_factory">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run.measure_factory">[docs]</a>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">measure_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">norm</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">doc</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">],</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Used as decorator to attach a measure factory (the decorated object, assumed callable) to a subclass *cls* of this class. The factory is then available as method :meth:`add&lt;name&gt;Measure` using the provided *name*. Its invocation accepts a parameter :attr:`label` under which its result in stored in the measures registry (by default, the label is the lowercase version of *name*).</span>

<span class="sd">:param name: short name for the factory</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s1">&#39;mean&#39;</span><span class="p">:</span><span class="n">partial</span><span class="p">(</span><span class="n">AvgAccumulator</span><span class="p">,</span><span class="n">feed</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())),</span>
          <span class="s1">&#39;sum&#39;</span><span class="p">:</span><span class="n">partial</span><span class="p">(</span><span class="n">SumAccumulator</span><span class="p">,</span><span class="n">feed</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span>
          <span class="s1">&#39;none&#39;</span><span class="p">:</span><span class="n">partial</span><span class="p">(</span><span class="n">ListAccumulator</span><span class="p">,</span><span class="n">feed</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span>
        <span class="p">}[</span><span class="n">m</span><span class="o">.</span><span class="n">reduction</span><span class="p">](</span><span class="n">descr</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">acc</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;add</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">Measure&#39;</span><span class="p">,</span><span class="n">F</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">doc</span><span class="p">:</span> <span class="n">F</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Measure factory for :class:`</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">`. The result is assigned as attribute *label* in the measures register.&#39;</span>
      <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">app</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Run.listener_factory">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run.listener_factory">[docs]</a>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">listener_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">doc</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">],</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Used as decorator to attach a listener factory (the decorated object, assumed callable) to a subclass *cls* of this class. The factory is then available as method :meth:`add&lt;name&gt;Listener` using the provided *name*. Its invocation accepts a parameter :attr:`label` under which its result in stored in the listeners registry (by default, the label is the lowercase version of *name*). The decorated object may have an attribute :attr:`tools` listing the name of tool attributes, which are passed into as attribute :attr:`&lt;name&gt;_tools` of *cls*.</span>

<span class="sd">:param name: short name for the factory</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
      <span class="k">if</span> <span class="n">doc</span><span class="p">:</span> <span class="n">F</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Listener factory for :class:`</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">`. The result is assigned as attribute *label* in the listeners register.&#39;</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;add</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">Listener&#39;</span><span class="p">,</span><span class="n">F</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tools</span><span class="o">:=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;tools&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_tools&#39;</span><span class="p">,</span><span class="n">udict</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tools</span><span class="p">)))</span>
      <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">app</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="nd">@contextmanager</span>
  <span class="k">def</span> <span class="nf">activate_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">evs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_events_</span><span class="p">:</span> <span class="p">((</span><span class="n">ev</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">evs</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">:=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s1">&#39;on_&#39;</span><span class="o">+</span><span class="n">ev</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">callbacks</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">L</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">yield</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">L</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">ev</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">c</span><span class="p">)</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Run.describe">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Run.describe">[docs]</a>
  <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tab</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Prints out the list of configuration attributes (with their values) as well as the list of measures and listeners.</span>

<span class="sd">:param tab: an indentation string</span>
<span class="sd">:param file: passed to the print function</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">tab</span><span class="o">=</span><span class="n">tab</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;measures.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">tab</span><span class="o">+</span><span class="s1">&#39;  &#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;listeners.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
      <span class="n">x</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">tab</span><span class="o">=</span><span class="n">tab</span><span class="o">+</span><span class="s1">&#39;  &#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span></div>


  <span class="nd">@property</span> <span class="c1"># shorthand for walltime()</span>
  <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span><span class="p">()</span>

  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_listeners</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_info</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">:=</span><span class="n">info</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;,origin[path=</span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">,mtime=</span><span class="si">{</span><span class="n">ctime</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span><span class="si">}</span><span class="s1">,walltime=</span><span class="si">{</span><span class="n">time_fmt</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">walltime</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">[host=</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">,pid=</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s1">,started=</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span><span class="si">}{</span><span class="n">origin</span><span class="si">}</span><span class="s1">]&#39;</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="Net">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Net">[docs]</a>
<span class="k">class</span> <span class="nc">Net</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class are nets with an embedding phase immediately followed by a loss.</span>

<span class="sd">:param loss: a loss function, or layer if it is parametrized</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

  <span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the loss (scalar tensor) for an input as a sequence of tensors&quot;&quot;&quot;</span>
  <span class="n">loss_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Factory for the :attr:`loss`&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loss</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_factory</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">loss</span> <span class="ow">or</span> <span class="p">{}))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,(</span><span class="nb">dict</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span> <span class="k">else</span> <span class="n">loss</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Net.embedding">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Net.embedding">[docs]</a>
  <span class="k">def</span> <span class="nf">embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">inputs</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a (seq of) embedding representations for each (seq of) input feature in the batch. This implementation raises a :class:`NotImplementedError` exception.&quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Net.forward">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Net.forward">[docs]</a>
  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sequentially composes embedding and loss.&quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">))</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="SupervisedNet">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.SupervisedNet">[docs]</a>
<span class="k">class</span> <span class="nc">SupervisedNet</span> <span class="p">(</span><span class="n">Net</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class are supervised task models, where each component of a batch consists of one or more feature tensors(s) and a label tensor. All tensors have the batch size as first dimension. The :meth:`embedding` method returns the result of applying a scoring net to the features and leaves the label unchanged.</span>

<span class="sd">:param net: The scoring net</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">loss_factory</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span>
  <span class="n">score</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The scoring net, acting only on the feature inputs&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">net</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">(),</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">net</span>
<div class="viewcode-block" id="SupervisedNet.embedding">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.SupervisedNet.embedding">[docs]</a>
  <span class="k">def</span> <span class="nf">embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
    <span class="o">*</span><span class="n">feats</span><span class="p">,</span><span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="o">*</span><span class="n">feats</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scores</span><span class="p">,</span><span class="n">labels</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="Measure">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.Measure">[docs]</a>
<span class="k">class</span> <span class="nc">Measure</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Base class for measures.&quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">Agg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span><span class="s1">&#39;none&#39;</span><span class="p">:(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">)}</span>
  <span class="n">reduction</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">reduction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Agg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="p">]</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(reduction=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="si">}</span><span class="s1">)&#39;</span></div>


<span class="k">def</span> <span class="nf">predefine_measures_from_standard_losses</span><span class="p">():</span> <span class="c1"># invoked only once below, then destroyed</span>
  <span class="c1"># adds one measure to class Run for each loss function defined in torch.nn</span>
  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">):</span> <span class="n">Run</span><span class="o">.</span><span class="n">measure_factory</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span><span class="n">doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="n">predefine_measures_from_standard_losses</span><span class="p">()</span>
<span class="k">del</span> <span class="n">predefine_measures_from_standard_losses</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="ZeroOneMeasure">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.ZeroOneMeasure">[docs]</a>
<span class="nd">@Run</span><span class="o">.</span><span class="n">measure_factory</span><span class="p">(</span><span class="s1">&#39;ZeroOne&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ZeroOneMeasure</span> <span class="p">(</span><span class="n">Measure</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class measure accuracy for classification runs.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scores</span><span class="p">,</span><span class="n">labels</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="RunListener">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.RunListener">[docs]</a>
<span class="k">class</span> <span class="nc">RunListener</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class are listener objects, which can be bound to a :class:`Run` instance. All parameters of the constructor are processed by method :meth:`setup`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">schedule</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Schedule</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Schedule to control the action of the listener per (relevant) event&quot;&quot;&quot;</span>
  <span class="n">cond</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">bool</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Filtering condition to control the action of the listener per (relevant) event, based on :attr:`schedule`&quot;&quot;&quot;</span>
  <span class="n">alias</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="s1">&#39;end_step&#39;</span><span class="p">,</span><span class="s1">&#39;epoch&#39;</span><span class="p">:</span><span class="s1">&#39;end_epoch&#39;</span><span class="p">}</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Alias for (relevant) events&quot;&quot;&quot;</span>
  <span class="n">info</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="n">Any</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run information generator per info-type&quot;&quot;&quot;</span>
  <span class="n">active</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Whether this instance is actively listening to events&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">fmtwrap</span><span class="p">({})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="RunListener.setup">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.RunListener.setup">[docs]</a>
  <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">itrain</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tloss&#39;</span><span class="p">:</span><span class="n">run</span><span class="o">.</span><span class="n">r_loss</span><span class="p">}),</span>
      <span class="n">ivalid</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">:</span> <span class="n">run</span><span class="o">.</span><span class="n">eval_valid</span><span class="p">()),</span>
      <span class="n">itest</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">:</span> <span class="n">run</span><span class="o">.</span><span class="n">eval_test</span><span class="p">()),</span>
      <span class="n">icheckpoint</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">:</span> <span class="n">run</span><span class="o">.</span><span class="n">checkpoint_status</span><span class="p">()),</span>
      <span class="n">cond</span><span class="p">:</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="o">|</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">|</span><span class="nb">int</span><span class="o">|</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="nb">float</span><span class="o">|</span><span class="nb">int</span><span class="p">]]</span><span class="o">|</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">{},</span>
      <span class="n">active</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Processes the constructor parameters.</span>

<span class="sd">:param itrain: extracts train information about a run</span>
<span class="sd">:param ivalid: extracts valid information about a run</span>
<span class="sd">:param itest: extracts test information about a run</span>
<span class="sd">:param icheckpoint: extracts checkpoint information about a run</span>
<span class="sd">:param cond: assignment of a target and a schedule to control the actions of the listener</span>
<span class="sd">:param active: whether to bind the listener on execution</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="k">return</span> <span class="p">(</span><span class="nb">float</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="ow">or</span> <span class="s1">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="nb">int</span><span class="p">)(</span><span class="n">p</span><span class="p">),(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span><span class="nb">getattr</span><span class="p">(</span><span class="n">run</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">udict</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="n">itrain</span><span class="p">,</span><span class="n">valid</span><span class="o">=</span><span class="n">ivalid</span><span class="p">,</span><span class="n">test</span><span class="o">=</span><span class="n">itest</span><span class="p">,</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">icheckpoint</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">active</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cond</span> <span class="o">=</span> <span class="n">udict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ev</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">cond</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span><span class="n">ev</span><span class="p">),</span><span class="o">*</span><span class="n">parse</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>

  <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ev</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Schedule</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">run</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">:</span> <span class="n">s</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
  <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;schedule&#39;</span><span class="p">:{</span><span class="n">ev</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">goal</span> <span class="k">for</span> <span class="n">ev</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">items</span><span class="p">()}}</span>
  <span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ev</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">g</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="BaseRunListener">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.BaseRunListener">[docs]</a>
<span class="nd">@Run</span><span class="o">.</span><span class="n">listener_factory</span><span class="p">(</span><span class="s1">&#39;Base&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BaseRunListener</span> <span class="p">(</span><span class="n">RunListener</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class logs run events through a :class:`logging.Logger` instance.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">action</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="kc">None</span><span class="p">]]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Logging action per stage&quot;&quot;&quot;</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="BaseRunListener.setup">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.BaseRunListener.setup">[docs]</a>
  <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">logger</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
      <span class="n">status</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Run</span><span class="p">],</span><span class="n">Tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
          <span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span><span class="s1">&#39;COMP&#39;</span><span class="p">,</span><span class="s1">&#39;STEP&#39;</span><span class="p">,</span><span class="s1">&#39;EPO&#39;</span><span class="p">,</span><span class="s1">&#39;BAT&#39;</span><span class="p">),</span>
          <span class="p">(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">:</span> <span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">walltime</span><span class="p">(),</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="p">),</span><span class="n">run</span><span class="o">.</span><span class="n">step</span><span class="p">,</span><span class="n">run</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="n">run</span><span class="o">.</span><span class="n">r_step</span><span class="p">)),</span>
      <span class="p">),</span>
      <span class="n">status_fmt</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s%%</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1">/</span><span class="si">%5s</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%6.1f</span><span class="s1"> </span><span class="si">%5.1f%%</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%4d</span><span class="s1">/</span><span class="si">%5d</span><span class="s1">&#39;</span><span class="p">),</span>
      <span class="n">fmt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="o">**</span><span class="n">ka</span>
  <span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Processes the constructor parameters. Parameters in *ka* are passed on to the method of the super class.</span>

<span class="sd">:param logger: logger to use to report information</span>
<span class="sd">:param status: a pair of a sequence of field names and a matching sequence of field retrievers</span>
<span class="sd">:param status_fmt: a pair of format strings (% convention) for the sequence of field name and the sequences of retrieved field values</span>
<span class="sd">:param fmt: a dictionary assigning a format to each free field name (default is .3f)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="n">fmt_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;nerr&#39;</span><span class="p">:</span><span class="s1">&#39;d&#39;</span><span class="p">}</span><span class="o">|</span><span class="p">(</span><span class="n">fmt</span> <span class="ow">or</span> <span class="p">{}),</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;.3f&#39;</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="fm">__format__</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">udict</span><span class="p">({</span>
      <span class="n">k</span><span class="p">:(</span><span class="k">lambda</span> <span class="n">run</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">status_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">: %s&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span><span class="o">*</span><span class="n">s</span><span class="p">(</span><span class="n">run</span><span class="p">),</span><span class="n">fmt_</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">run</span><span class="p">))))</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">})</span>
    <span class="k">def</span> <span class="nf">aheader</span><span class="p">(</span><span class="n">run</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">status_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RUN </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">run</span><span class="p">);</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">aheader</span></div>


  <span class="k">def</span> <span class="nf">on_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">run</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">valid</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">on_end_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="o">.</span><span class="n">end_step</span><span class="p">(</span><span class="n">run</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">on_end_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="o">.</span><span class="n">end_epoch</span><span class="p">(</span><span class="n">run</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">valid</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">on_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">run</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="RunMlflowListener">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.RunMlflowListener">[docs]</a>
<span class="nd">@Run</span><span class="o">.</span><span class="n">listener_factory</span><span class="p">(</span><span class="s1">&#39;Mlflow&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RunMlflowListener</span> <span class="p">(</span><span class="n">RunListener</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class logs run events to a MLFlow experiment repository.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">tools</span> <span class="o">=</span> <span class="s1">&#39;load_model&#39;</span><span class="p">,</span>
  <span class="n">run_id</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="RunMlflowListener.setup">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.RunMlflowListener.setup">[docs]</a>
  <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">uri</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exp</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param uri: mlflow tracking uri</span>
<span class="sd">:param exp: experiment name</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="kn">import</span> <span class="nn">mlflow</span><span class="o">,</span> <span class="nn">mlflow.pytorch</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span></div>


  <span class="k">def</span> <span class="nf">on_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">mlflow</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[:</span><span class="mi">250</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
      <span class="k">except</span><span class="p">:</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">end_run</span><span class="p">();</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">delete_run</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="p">);</span> <span class="k">raise</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">mlflow</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">net</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">);</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">run</span><span class="p">));</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">end_run</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">on_end_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">mlflow</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="o">.</span><span class="n">end_step</span><span class="p">(</span><span class="n">run</span><span class="p">):</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">run</span><span class="p">),</span><span class="n">run</span><span class="o">.</span><span class="n">step</span><span class="p">);</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">on_end_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">run</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">mlflow</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="o">.</span><span class="n">end_epoch</span><span class="p">(</span><span class="n">run</span><span class="p">):</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">valid</span><span class="p">(</span><span class="n">run</span><span class="p">),</span><span class="n">run</span><span class="o">.</span><span class="n">step</span><span class="p">);</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;run_id&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span><span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()}</span>
  <span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">D</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">];</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="RunMlflowListener.load_model">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.RunMlflowListener.load_model">[docs]</a>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">uri</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">exp</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">run_id</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">epoch</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns a model saved in a run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="kn">import</span> <span class="nn">mlflow</span><span class="o">,</span> <span class="nn">mlflow.pytorch</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">run_id</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">search_runs</span><span class="p">()</span><span class="o">.</span><span class="n">run_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># most recent run</span>
    <span class="k">return</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;runs:/</span><span class="si">{}</span><span class="s1">/model</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_id</span><span class="p">,(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)),</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="DataInfo">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.DataInfo">[docs]</a>
<span class="k">class</span> <span class="nc">DataInfo</span> <span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">source</span><span class="p">:</span> <span class="n">ClassificationDatasource</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Source of the data&quot;&quot;&quot;</span>
  <span class="n">train</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Size of the train split&quot;&quot;&quot;</span>
  <span class="n">valid</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Size of the validation split&quot;&quot;&quot;</span>
  <span class="n">test</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Size of the test split&quot;&quot;&quot;</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="ClassificationDatasource">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.ClassificationDatasource">[docs]</a>
<span class="k">class</span> <span class="nc">ClassificationDatasource</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class is a data source for classification training. Attributes (\*) must be instantiated at creation time.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="n">classes</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)Descriptive names for the classes&quot;&quot;&quot;</span>
  <span class="n">train</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)The train split of the data source&quot;&quot;&quot;</span>
  <span class="n">test</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;(\*)The test split of the data source&quot;&quot;&quot;</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ClassificationDatasource.mpl">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.ClassificationDatasource.mpl">[docs]</a>
  <span class="k">def</span> <span class="nf">mpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ax</span><span class="p">:</span><span class="s1">&#39;matplotlib.Axes&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[</span><span class="s1">&#39;numpy.array&#39;</span><span class="p">],</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns a callable, which, when passed a data instance, displays it on *ax* (its label is also used as title of *ax*). This implementation raises a :class:`NotImplementedError`.</span>

<span class="sd">:param ax: a display area for a data instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ClassificationDatasource.loaders">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.ClassificationDatasource.loaders">[docs]</a>
  <span class="k">def</span> <span class="nf">loaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pcval</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns a dictionary which can be passed as keyword arguments to the :class:`Run` constructor to initialise its required attributes:</span>

<span class="sd">* non visible attributes :attr:`train_data`, :attr:`valid_data`, :attr:`test_data`, obtained by calling :class:`torch.utils.data.DataLoader` on the corresponding split with key-word parameters *ka* (with prefix `_` removed from keys);</span>
<span class="sd">* a visible attribute :attr:`data` holding a description of the datasource;</span>
<span class="sd">* all the attributes (visible or not) in *ka*, so they appear as attributes of the run.</span>

<span class="sd">:param pcval: proportion (between 0. and 1.) of instances from the train split to use for validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">D</span><span class="p">);</span> <span class="n">nvalid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pcval</span><span class="o">*</span><span class="n">n</span><span class="p">);</span> <span class="n">ntrain</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="n">nvalid</span>
    <span class="n">train</span><span class="p">,</span><span class="n">valid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">D</span><span class="p">,(</span><span class="n">ntrain</span><span class="p">,</span><span class="n">nvalid</span><span class="p">))</span>
    <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">datainfo</span><span class="o">=</span><span class="n">DataInfo</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">train</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),</span><span class="n">valid</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span><span class="n">test</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)),</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="n">ka</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="p">),</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ka</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">split</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">),(</span><span class="n">train</span><span class="p">,</span><span class="n">valid</span><span class="p">,</span><span class="n">test</span><span class="p">)):</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">split</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="n">c</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ClassificationDatasource.display">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.ClassificationDatasource.display">[docs]</a>
  <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">rowspec</span><span class="p">:</span><span class="nb">float</span><span class="o">|</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span><span class="o">|</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">colspec</span><span class="p">:</span><span class="nb">float</span><span class="o">|</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span><span class="o">|</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">dataset</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">ka</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Displays a set of labelled data instances *dataset* in a grid. The specification of the rows (resp. cols) of the grid consists of three numbers:</span>

<span class="sd">* height (resp. width) of the cells; required</span>
<span class="sd">* number of rows (resp. cols); if -1 it is adjusted so the the whole dataset fits in the grid; default: 1</span>
<span class="sd">* additional space in the row (resp. col) dimension; default: 0.</span>

<span class="sd">At most one of the number of rows or columns can be -1. When both are positive and the dataset does not fit in the grid, a slider is created to allow page browsing through the dataset.</span>

<span class="sd">:param rowspec,colspec: specification of the rows/cols of the grid</span>
<span class="sd">:param dataset: the data to display</span>
<span class="sd">:param ka: keyword arguments passed to :func:`matplotlib.pyplot.subplots` to create the grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">IntSlider</span><span class="p">,</span><span class="n">Text</span><span class="p">,</span><span class="n">Label</span><span class="p">,</span><span class="n">HBox</span><span class="p">,</span><span class="n">VBox</span><span class="p">,</span><span class="n">Button</span><span class="p">,</span><span class="n">Output</span>
    <span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">subplots</span><span class="p">,</span> <span class="n">close</span>
    <span class="k">def</span> <span class="nf">disp</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">update</span><span class="p">),(</span><span class="o">*</span><span class="n">feat</span><span class="p">,</span><span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span><span class="n">sample</span><span class="p">,</span><span class="n">fillvalue</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,)):</span>
        <span class="n">visible</span> <span class="o">=</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="n">visible</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">visible</span><span class="p">:</span>
          <span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">feat</span><span class="p">)</span>
          <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">label</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-small&#39;</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">adj</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">K</span><span class="p">):</span>
      <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">K</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">parsespec</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sz</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">sz</span><span class="o">&gt;</span><span class="mf">0.</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pad</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">pad</span><span class="o">&gt;=</span><span class="mf">0.</span>
        <span class="k">return</span> <span class="n">sz</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">pad</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">spec</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">fmt</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="n">dataset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span> <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">rowsz</span><span class="p">,</span><span class="n">nrow</span><span class="p">,</span><span class="n">rowp</span> <span class="o">=</span> <span class="n">parsespec</span><span class="p">(</span><span class="n">rowspec</span><span class="p">)</span>
    <span class="n">colsz</span><span class="p">,</span><span class="n">ncol</span><span class="p">,</span><span class="n">colp</span> <span class="o">=</span> <span class="n">parsespec</span><span class="p">(</span><span class="n">colspec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ncol</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="n">nrow</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">adj</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">nrow</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">nrow</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="n">ncol</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="n">nrow</span> <span class="o">=</span> <span class="n">adj</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">ncol</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">nrow</span><span class="o">*</span><span class="n">ncol</span>
    <span class="n">lastpage</span> <span class="o">=</span> <span class="n">adj</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">K</span><span class="p">)</span>

    <span class="n">w_closeb</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="n">tooltip</span><span class="o">=</span><span class="s1">&#39;Close browser&#39;</span><span class="p">,</span><span class="n">layout</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;1px&#39;</span><span class="p">))</span>
    <span class="n">w_sel</span> <span class="o">=</span> <span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">lastpage</span><span class="p">,</span><span class="n">layout</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;10cm&#39;</span><span class="p">),</span><span class="n">readout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">w_page</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">layout</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="mf">.3</span><span class="o">+</span><span class="mf">.3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lastpage</span><span class="p">))</span><span class="si">}</span><span class="s1">cm&#39;</span><span class="p">))</span>
    <span class="n">w_out</span> <span class="o">=</span> <span class="n">Output</span><span class="p">()</span>
    <span class="n">w_main</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">((</span><span class="n">HBox</span><span class="p">((</span><span class="n">w_closeb</span><span class="p">,</span><span class="n">Label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> page:&#39;</span><span class="p">),</span><span class="n">w_page</span><span class="p">,</span><span class="n">w_sel</span><span class="p">)),</span><span class="n">w_out</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">w_out</span><span class="p">:</span>
      <span class="n">gs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;left&#39;</span><span class="p">:</span><span class="mf">.05</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">:</span><span class="mf">.95</span><span class="p">}</span><span class="o">|</span><span class="n">ka</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gridspec_kw&#39;</span><span class="p">,{})</span>
      <span class="n">fig</span><span class="p">,</span><span class="n">axes</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span><span class="p">,</span><span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">ncol</span><span class="o">*</span><span class="n">colsz</span><span class="o">+</span><span class="n">colp</span><span class="p">,</span><span class="n">nrow</span><span class="o">*</span><span class="n">rowsz</span><span class="o">+</span><span class="n">rowp</span><span class="p">),</span><span class="n">gridspec_kw</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">disp_</span><span class="p">():</span> <span class="n">w_page</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">w_sel</span><span class="o">.</span><span class="n">value</span><span class="p">);</span> <span class="n">disp</span><span class="p">([</span><span class="n">dataset</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">w_sel</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">K</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">w_sel</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">))])</span>
    <span class="k">def</span> <span class="nf">close_</span><span class="p">():</span> <span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">);</span> <span class="n">w_main</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">w_closeb</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">close_</span><span class="p">())</span>
    <span class="n">w_sel</span><span class="o">.</span><span class="n">observe</span><span class="p">((</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">disp_</span><span class="p">()),</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ax</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
    <span class="n">disp_</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">w_main</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<span class="c1"># Miscellaneous utilities</span>
<span class="c1">#==================================================================================================</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">Schedule</span><span class="p">:</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;it&#39;</span><span class="p">,</span><span class="s1">&#39;goal&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="n">Iterable</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">it</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">:</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flag</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="clone_module">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.clone_module">[docs]</a>
<span class="k">def</span> <span class="nf">clone_module</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Clones a :class:`torch.Module` *m* into another one *out* or a new one if *out* is :const:`None`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
  <span class="n">out</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">out</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="training">
<a class="viewcode-back" href="../../mod_experiment.html#PYTOOLS.experiment.training">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">training</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns a context which saves the value of :attr:`training` in *obj* on enter and restores it on exit.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="n">oldv</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">training</span><span class="p">;</span> <span class="n">obj</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">v</span><span class="p">);</span> <span class="k">yield</span><span class="p">;</span> <span class="n">obj</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">oldv</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">device</span><span class="p">):</span> <span class="k">return</span> <span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">L</span><span class="p">)</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">Accumulator</span><span class="p">:</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">feed</span><span class="p">:</span><span class="n">Callable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">norm</span><span class="p">:</span><span class="n">Callable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">descr</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feed</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">feed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">feed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">norm</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">repr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">descr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">descr</span>
  <span class="k">def</span> <span class="nf">ini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ini</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
  <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repr</span>
  <span class="k">def</span> <span class="nf">_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">AvgAccumulator</span> <span class="p">(</span><span class="n">Accumulator</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="c1"># input as pair of scalars (weight,value)</span>
  <span class="k">def</span> <span class="nf">_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="k">return</span> <span class="mf">0.</span>
  <span class="k">def</span> <span class="nf">_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span> <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span> <span class="o">+=</span> <span class="n">w</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">+=</span> <span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_w</span><span class="p">)</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">MeanAccumulator</span> <span class="p">(</span><span class="n">Accumulator</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="nf">_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="k">return</span> <span class="mf">0.</span>
  <span class="k">def</span> <span class="nf">_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">+=</span> <span class="mf">1.</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">SumAccumulator</span> <span class="p">(</span><span class="n">Accumulator</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="nf">_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="mf">0.</span>
  <span class="k">def</span> <span class="nf">_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">+=</span> <span class="n">x</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">ListAccumulator</span> <span class="p">(</span><span class="n">Accumulator</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">def</span> <span class="nf">_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>
  <span class="k">def</span> <span class="nf">_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># #==================================================================================================</span>
<span class="c1"># @Run.listener_factory(&#39;Tensorboard&#39;)</span>
<span class="c1"># class RunTensorboardListener (RunListener):</span>
<span class="c1">#   r&quot;&quot;&quot;</span>
<span class="c1"># Instances of this class provide tensorboard logging for runs. Limited functionality if standalone tb is installed (without tf).</span>
<span class="c1">#   &quot;&quot;&quot;</span>
<span class="c1"># #==================================================================================================</span>
<span class="c1"># #--------------------------------------------------------------------------------------------------</span>
<span class="c1">#   def set(self,</span>
<span class="c1">#     itrain:Callable[[Run],Tuple[Any,...]]=(lambda run: {&#39;loss/train&#39;:run.loss.val()}),</span>
<span class="c1">#     ivalid:Callable[[Run],Tuple[Any,...]]=(lambda run: dict((k+&#39;/valid&#39;,v) for k,v in run.eval_valid().items())),</span>
<span class="c1">#     itest:Callable[[Run],Tuple[Any,...]] =(lambda run: dict((k+&#39;/test&#39;,v) for k,v in run.eval_test().items())),</span>
<span class="c1">#     **ka</span>
<span class="c1">#   ):</span>
<span class="c1">#     r&quot;&quot;&quot;</span>
<span class="c1"># :param uri: mlflow tracking uri</span>
<span class="c1"># :param exp: experiment name</span>
<span class="c1"># :param itrain: function returning train info on a run</span>
<span class="c1"># :param ivalid: function returning validation info on a run</span>
<span class="c1"># :param itest: function returning test info on a run</span>
<span class="c1">#</span>
<span class="c1"># Computes a number of information loggers, stored in attributes :attr:`itrain`, :attr:`ivalid`, :attr:`itest`, :attr:`iprogress`, :attr:`open_tb`, :attr:`close_tb`. The *uri* must refer to a valid tensorboard experiment storage.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1"># #--------------------------------------------------------------------------------------------------</span>
<span class="c1">#     log_metrics = lambda f,run: tuple(run.tbwriter.add_scalar(k,v,run.step) for k,v in f(run).items())</span>
<span class="c1">#     self.itrain = None if itrain is None else partial(log_metrics,itrain)</span>
<span class="c1">#     self.ivalid = None if ivalid is None else partial(log_metrics,ivalid)</span>
<span class="c1">#     self.itest = None if itest is None else partial(log_metrics,itest)</span>
<span class="c1">#     self.iprogress = lambda run: run.tbwriter.add_scalar(&#39;progress&#39;,run.progress,run.step)</span>
<span class="c1">#     self.checkpoint = None # MISSING: checkpoint</span>
<span class="c1">#     self.open_tb = lambda run: tuple(run.tbwriter.add_text(k,&#39;&lt;pre&gt;{}&lt;/pre&gt;&#39;.format(v.replace(&#39;&amp;&#39;,&#39;&amp;amp;&#39;).replace(&#39;&lt;&#39;,&#39;&amp;lt;&#39;).replace(&#39;&gt;&#39;,&#39;&amp;gt;&#39;)),0) for k,v in run._config.items())</span>
<span class="c1">#     self.close_tb = None # MISSING: save model</span>
<span class="c1">#     super().set(**ka)</span>
<span class="c1">#</span>
<span class="c1"># #--------------------------------------------------------------------------------------------------</span>
<span class="c1">#   def set2(self,</span>
<span class="c1">#     train_p:Callable[[Run],bool]|bool=False,</span>
<span class="c1">#     valid_p:Callable[[Run],bool]|bool=False,</span>
<span class="c1">#     checkpoint_p:Callable[[Run],bool]|bool=False,</span>
<span class="c1">#     **ka</span>
<span class="c1">#   ):</span>
<span class="c1">#     r&quot;&quot;&quot;</span>
<span class="c1"># :param train_p: run selector for train info logging at each batch</span>
<span class="c1"># :param valid_p: run selector for validation info logging at each epoch</span>
<span class="c1"># :param checkpoint_p: run selector for checkpointing at each epoch</span>
<span class="c1">#</span>
<span class="c1"># Configures the callbacks of this listener, stored as attributes :attr:`on_open`, :attr:`on_close`, :attr:`on_batch`, :attr:`on_epoch`, using components defined by method :meth:`set`.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1"># #--------------------------------------------------------------------------------------------------</span>
<span class="c1">#     self.on_open = abs(PROC(self.open_tb))</span>
<span class="c1">#     self.on_close = abs(PROC(self.ivalid)+PROC(self.itest)+PROC(self.iprogress)+PROC(self.close_tb))</span>
<span class="c1">#     self.on_batch = abs(PROC(self.itrain)%train_p)</span>
<span class="c1">#     self.on_epoch = abs(PROC(self.iprogress)+PROC(self.ivalid)%valid_p+PROC(self.checkpoint)%checkpoint_p)</span>
<span class="c1">#     super().set2(**ka)</span>
<span class="c1">#</span>
<span class="c1"># #--------------------------------------------------------------------------------------------------</span>
<span class="c1">#   def set3(self,root=None,exp=None,**ka):</span>
<span class="c1">#     r&quot;&quot;&quot;</span>
<span class="c1"># Protects callbacks :attr:`on_open` and :attr:`on_close` from exceptions to make sure the tensorboard run is not left in a corrupted state.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1"># #--------------------------------------------------------------------------------------------------</span>
<span class="c1">#     from torch.utils.tensorboard import SummaryWriter</span>
<span class="c1">#     from pathlib import Path</span>
<span class="c1">#     from datetime import datetime</span>
<span class="c1">#     import shutil</span>
<span class="c1">#     root = Path(root).resolve()</span>
<span class="c1">#     assert root.is_dir()</span>
<span class="c1">#     exp = root/exp</span>
<span class="c1">#     exp.mkdir(exist_ok=True)</span>
<span class="c1">#     def on_open(run,f=self.on_open):</span>
<span class="c1">#       path = exp/&#39;{0}_{1.host}_{1.pid}&#39;.format(datetime.now().strftime(&#39;%Y%m%d_%H%M%S&#39;),run.process_info)</span>
<span class="c1">#       run.tbwriter = SummaryWriter(log_dir=str(path))</span>
<span class="c1">#       try: f(run)</span>
<span class="c1">#       except:</span>
<span class="c1">#         run.tbwriter.close()</span>
<span class="c1">#         if path.exists(): shutil.rmtree(path)</span>
<span class="c1">#         raise</span>
<span class="c1">#     def on_close(run,f=self.on_close):</span>
<span class="c1">#       try: f(run)</span>
<span class="c1">#       finally: run.tbwriter.close()</span>
<span class="c1">#     self.on_open,self.on_close = on_open,on_close</span>
<span class="c1">#     super().set3(**ka)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Jean-Marc Andreoli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>