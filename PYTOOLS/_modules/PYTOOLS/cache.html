<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PYTOOLS.cache &mdash; PYTOOLS  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PYTOOLS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mod_init.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS</span></code> (top level) — Generic utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_torch.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.torch</span></code> — Utilities for pytorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_animation.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.animation</span></code> — Animation utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_cache.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.cache</span></code> — A persistent cache mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_ipywidgets.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.ipywidgets</span></code> — Widget utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_polling.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.polling</span></code> — Generic polling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_simpy.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.simpy</span></code> — Utilities for simpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_experiment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.experiment</span></code> — Utilities for pytorch experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mod_tensorboard_manager.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PYTOOLS.tensorboard_manager</span></code> — A server of tensorboard servers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PYTOOLS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../PYTOOLS.html">PYTOOLS</a></li>
      <li class="breadcrumb-item active">PYTOOLS.cache</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for PYTOOLS.cache</h1><div class="highlight"><pre>
<span></span><span class="c1"># File:                 cache.py</span>
<span class="c1"># Creation date:        2015-03-19</span>
<span class="c1"># Contributors:         Jean-Marc Andreoli</span>
<span class="c1"># Language:             python</span>
<span class="c1"># Purpose:              Persistent cache management</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">logging</span><span class="p">;</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">update_wrapper</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">WeakValueDictionary</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">SQliteNew</span><span class="p">,</span> <span class="n">size_fmt</span><span class="p">,</span> <span class="n">time_fmt</span><span class="p">,</span> <span class="n">html_table</span><span class="p">,</span> <span class="n">html_parlist</span><span class="p">,</span> <span class="n">HtmlPlugin</span><span class="p">,</span> <span class="n">pickleclass</span>

<span class="n">SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">CREATE TABLE Block (</span>
<span class="s1">  oid INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s1">  functor PICKLE NOT NULL</span>
<span class="s1">  );</span>

<span class="s1">CREATE TABLE Cell (</span>
<span class="s1">  oid INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s1">  block REFERENCES Block(oid) NOT NULL,</span>
<span class="s1">  ckey BLOB NOT NULL,</span>
<span class="s1">  tstamp TIMESTAMP DEFAULT ( datetime(&#39;now&#39;) ),</span>
<span class="s1">  hits INTEGER DEFAULT 0,</span>
<span class="s1">  size INTEGER DEFAULT 0,</span>
<span class="s1">  duration REAL</span>
<span class="s1">  );</span>

<span class="s1">CREATE UNIQUE INDEX BlockIndex ON Block (functor);</span>
<span class="s1">CREATE UNIQUE INDEX CellIndex ON Cell (block, ckey);</span>
<span class="s1">CREATE INDEX CellIndex2 ON Cell (tstamp);</span>

<span class="s1">CREATE TRIGGER BlockDeleteTrigger AFTER DELETE ON Block</span>
<span class="s1">  BEGIN DELETE FROM Cell WHERE block=OLD.oid; END;</span>

<span class="s1">CREATE TRIGGER CellDeleteTrigger AFTER DELETE ON Cell</span>
<span class="s1">  BEGIN SELECT cellrm(OLD.oid,OLD.size); END;</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s1">&#39;PICKLE&#39;</span><span class="p">,</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
<span class="n">sqlite3</span><span class="o">.</span><span class="n">enable_callback_tracebacks</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">BlockInfo</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BlockInfo&#39;</span><span class="p">,</span><span class="s1">&#39;hits ncell ncell_error ncell_pending&#39;</span><span class="p">)</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="CacheDB">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheDB">[docs]</a>
<span class="k">class</span> <span class="nc">CacheDB</span> <span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span><span class="n">HtmlPlugin</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class manage cache repositories. There is at most one instance of this class in a process for each normalised repository specification path. A cache repository contains cells, each cell corresponding to one cached value produced by a unique call, and possibly reused by later calls. Cells are clustered into blocks, each block grouping cells produced by the same call type, called a functor (of class :class:`AbstractFunctor`). Meta-information about blocks and cells are stored in an index in a sqlite3 database. The values themselves are persistently stored by a dedicated storage object (of class :class:`AbstractStorage`).</span>

<span class="sd">The index entry attached to a block describes the common functor of all the calls which produced its cells. A ``Block`` entry has the following field:</span>

<span class="sd">- ``oid``: a unique integer identifier of the block;</span>
<span class="sd">- ``functor``: the functor producing all the cells in the block; each functor is assumed to have a deterministic pickle byte-string which uniquely identifies it.</span>

<span class="sd">The index entry attached to a cell describes the call event which produced it. A ``Cell`` entry has the following fields:</span>

<span class="sd">- ``oid``: a unique integer identifier of the cell; also used to retrieve the value attached to the cell;</span>
<span class="sd">- ``block``: reference to the ``Block`` entry holding the functor of the call event which produced the cell;</span>
<span class="sd">- ``ckey``: the key of the call event which produced the cell;</span>
<span class="sd">- ``tstamp``: date of creation, last update or last reuse, of the cell;</span>
<span class="sd">- ``hits``: number of hits (reuse) since creation;</span>
<span class="sd">- ``size``: either 0 if the value is still being computed, or the size in bytes of the computed value, with a negative sign if that value is an exception;</span>
<span class="sd">- ``duration``: duration (in float sec) of its computation.</span>

<span class="sd">A :class:`CacheDB` instance acts as a mapping object, where the keys are block identifiers (:class:`int`) and values are :class:`CacheBlock` objects for the corresponding blocks.</span>

<span class="sd">Finally, :class:`CacheDB` instances have an HTML ipython display.</span>

<span class="sd">.. automethod:: __new__</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

  <span class="n">path</span><span class="p">:</span><span class="n">Path</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;the normalised path of this instance&quot;&quot;&quot;</span>
  <span class="n">dbpath</span><span class="p">:</span><span class="nb">str</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;the path to the sqlite database holding the index&quot;&quot;&quot;</span>
  <span class="n">storage</span><span class="p">:</span><span class="s1">&#39;AbstractStorage&#39;</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;the object managing the actual storage of the values&quot;&quot;&quot;</span>
  <span class="n">timeout</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">120.</span>

<div class="viewcode-block" id="CacheDB.__new__">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheDB.__new__">[docs]</a>
  <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">spec</span><span class="p">:</span><span class="n">CacheDB</span><span class="o">|</span><span class="n">Path</span><span class="o">|</span><span class="nb">str</span><span class="p">,</span><span class="n">listing</span><span class="o">=</span><span class="p">{},</span><span class="n">lock</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generates a :class:`CacheDB` object.</span>

<span class="sd">:param spec: specification of the cache folder</span>

<span class="sd">* If *spec* is a :class:`CacheDB` instance, that instance is returned</span>
<span class="sd">* If *spec* is a path to a directory, returns a :class:`CacheDB` instance whose storage is an instance of :class:`DefaultStorage` pointing to that directory</span>
<span class="sd">* Otherwise, *spec* must be a path to a file, returns a :class:`CacheDB` instance whose storage is unpickled from the file at *spec*.</span>

<span class="sd">Note that this constructor is locally cached on the resolved path *spec*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span><span class="n">CacheDB</span><span class="p">):</span> <span class="k">return</span> <span class="n">spec</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span><span class="n">Path</span><span class="p">):</span> <span class="n">path</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected: </span><span class="si">{</span><span class="n">CacheDB</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="nb">str</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">Path</span><span class="si">}</span><span class="s1">; Found: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
      <span class="bp">self</span> <span class="o">=</span> <span class="n">listing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">DefaultStorage</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
          <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cache repository specification path must be directory or file&#39;</span><span class="p">)</span>
        <span class="n">dbpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">dbpath</span><span class="p">)</span>
        <span class="n">SQliteNew</span><span class="p">(</span><span class="n">dbpath</span><span class="p">,</span><span class="n">SCHEMA</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbpath</span> <span class="o">=</span> <span class="n">dbpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="n">listing</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="bp">self</span></div>


  <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span>
  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
  <span class="c1"># no need to define &#39;__eq__&#39;: default &#39;is&#39; behaviour works due to &#39;__new__&#39; constructor</span>

  <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbpath</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;cellrm&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">remove</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span>

  <span class="k">def</span> <span class="nf">getblock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">functor</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">functor</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN IMMEDIATE TRANSACTION&#39;</span><span class="p">)</span>
      <span class="n">row</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid FROM Block WHERE functor=?&#39;</span><span class="p">,(</span><span class="n">p</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO Block (functor) VALUES (?)&#39;</span><span class="p">,(</span><span class="n">p</span><span class="p">,))</span><span class="o">.</span><span class="n">lastrowid</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="CacheDB.clear_obsolete">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheDB.clear_obsolete">[docs]</a>
  <span class="k">def</span> <span class="nf">clear_obsolete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">strict</span><span class="p">,</span><span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Clears all the blocks which are obsolete.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strict</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">strictf</span> <span class="o">=</span> <span class="nb">bool</span> <span class="k">if</span> <span class="n">strict</span> <span class="k">else</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">strictf</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">functor</span><span class="o">.</span><span class="n">obsolete</span><span class="p">())]</span>
    <span class="c1"># this may load modules which add new (non obsolete) entries, hence out of transaction</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span> <span class="k">return</span> <span class="n">L</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">L</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;obsolete&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">L</span><span class="p">))</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Block WHERE obsolete(oid)&#39;</span><span class="p">)</span>
      <span class="n">deleted</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">total_changes</span>
    <span class="k">if</span> <span class="n">deleted</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> DELETED(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">deleted</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deleted</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="c1"># Methods defining the Mapping behaviour</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT functor FROM Block WHERE oid=?&#39;</span><span class="p">,(</span><span class="n">block</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CacheBlock</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">functor</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Block WHERE oid=?&#39;</span><span class="p">,(</span><span class="n">block</span><span class="p">,))</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">total_changes</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">v</span><span class="p">:</span><span class="n">Any</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Direct create/update not permitted on Block&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid FROM Block&#39;</span><span class="p">):</span> <span class="k">yield</span> <span class="n">block</span>

  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT count(*) FROM Block&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="CacheDB.items">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheDB.items">[docs]</a>
  <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a view on this instance&#39;s blocks.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">block</span><span class="p">,</span><span class="n">functor</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid,functor FROM Block&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">block</span><span class="p">,</span> <span class="n">CacheBlock</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">functor</span><span class="o">=</span><span class="n">functor</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span></div>


<div class="viewcode-block" id="CacheDB.clear">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheDB.clear">[docs]</a>
  <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Removes all blocks from this instance.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Block&#39;</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="c1"># Representation methods</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

  <span class="k">def</span> <span class="nf">as_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_html_limit</span>
    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">();</span> <span class="n">closing</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">L</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_html_limit</span><span class="p">);</span> <span class="n">closing</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> more&#39;</span>
    <span class="k">return</span> <span class="n">html_table</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">k</span><span class="p">,(</span><span class="n">v</span><span class="p">,))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">L</span><span class="p">),</span><span class="n">fmts</span><span class="o">=</span><span class="p">((</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">as_html</span><span class="p">(</span><span class="n">_</span><span class="p">)),),</span><span class="n">opening</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="n">closing</span><span class="o">=</span><span class="n">closing</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Cache&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">&gt;&#39;</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="CacheBlock">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheBlock">[docs]</a>
<span class="k">class</span> <span class="nc">CacheBlock</span> <span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span><span class="n">HtmlPlugin</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class implements blocks of cells sharing the same functor.</span>

<span class="sd">:param db: specification of the cache repository where the block resides</span>
<span class="sd">:param functor: functor of the block</span>
<span class="sd">:param cacheonly: if :const:`True`, cell creation is disallowed</span>

<span class="sd">A :class:`CacheBlock` instance is callable, and calls take a single argument. Method :meth:`__call__` implements the cross-process cacheing mechanism which produces and reuses cache cells. It also implements a weak cache for local calls (within its process).</span>

<span class="sd">Furthermore, a :class:`CacheBlock` instance acts as a mapping where the keys are cell identifiers (:class:`int`) and values are tuples of meta-information about the cells (i.e. not the values of the cells: these are only accessible through calling).</span>

<span class="sd">Finally, :class:`CacheBlock` instances have an HTML ipython display.</span>

<span class="sd">.. automethod:: __call__</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

  <span class="n">db</span><span class="p">:</span> <span class="n">CacheDB</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;the :class:`CacheDB` instance this block belongs to&quot;&quot;&quot;</span>
  <span class="n">functor</span><span class="p">:</span><span class="s1">&#39;AbstractFunctor&#39;</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;the functor for this block (field ``functor`` in the ``Block`` table of the index is the functor&#39;s pickle)&quot;&quot;&quot;</span>
  <span class="n">block</span><span class="p">:</span><span class="nb">int</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;the identifier of this block (field ``oid`` in the ``Block`` table of the index)&quot;&quot;&quot;</span>
  <span class="n">cacheonly</span><span class="p">:</span><span class="nb">bool</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;whether cell creation is disabled&quot;&quot;&quot;</span>
  <span class="n">memory</span><span class="p">:</span> <span class="n">WeakValueDictionary</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;a local cache of calls within the current process&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">db</span><span class="p">:</span><span class="n">CacheDB</span><span class="o">|</span><span class="n">Path</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">functor</span><span class="p">:</span><span class="s1">&#39;AbstractFunctor&#39;</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">block</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cacheonly</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="o">=</span> <span class="n">CacheDB</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">functor</span> <span class="o">=</span> <span class="n">functor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">getblock</span><span class="p">(</span><span class="n">functor</span><span class="p">)</span> <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">block</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cacheonly</span> <span class="o">=</span> <span class="n">cacheonly</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">WeakValueDictionary</span><span class="p">()</span>

  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">))</span>
  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">CacheBlock</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="n">db</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">block</span>

<div class="viewcode-block" id="CacheBlock.clear_error">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheBlock.clear_error">[docs]</a>
  <span class="k">def</span> <span class="nf">clear_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dry_run</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Clears all the cells from this block which cache an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid FROM Cell WHERE block=? AND size&lt;0&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,))]</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Cell WHERE block=? AND size&lt;0&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,))</span>
      <span class="n">deleted</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">total_changes</span>
    <span class="k">if</span> <span class="n">deleted</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> DELETED(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">deleted</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deleted</span></div>


<div class="viewcode-block" id="CacheBlock.clear_overflow">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheBlock.clear_overflow">[docs]</a>
  <span class="k">def</span> <span class="nf">clear_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">dry_run</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Clears all the cells from this block except the *n* most recent (lru policy).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">1</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid FROM Cell WHERE block=? AND size&gt;0 ORDER BY tstamp DESC, oid DESC LIMIT -1 OFFSET ?&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,</span><span class="n">n</span><span class="p">))]</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Cell WHERE oid IN (SELECT oid FROM Cell WHERE block=? AND size&gt;0 ORDER BY tstamp DESC, oid DESC LIMIT -1 OFFSET ?)&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
      <span class="n">deleted</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">total_changes</span>
    <span class="k">if</span> <span class="n">deleted</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> DELETED(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">deleted</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deleted</span></div>


<div class="viewcode-block" id="CacheBlock.info">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheBlock.info">[docs]</a>
  <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns information about this block. Available attributes:</span>
<span class="sd">:attr:`hits`, :attr:`ncell`, :attr:`ncell_error`, :attr:`ncell_pending`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">ncell</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT CASE WHEN size ISNULL THEN </span><span class="se">\&#39;</span><span class="s1">pending</span><span class="se">\&#39;</span><span class="s1"> WHEN size&lt;0 THEN </span><span class="se">\&#39;</span><span class="s1">error</span><span class="se">\&#39;</span><span class="s1"> ELSE </span><span class="se">\&#39;\&#39;</span><span class="s1"> END AS status, count(*) FROM Cell WHERE block=? GROUP BY status&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,)))</span>
      <span class="n">hits</span><span class="p">,</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT sum(hits) FROM Cell WHERE block=?&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">BlockInfo</span><span class="p">((</span><span class="n">hits</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">ncell</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span><span class="n">ncell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">ncell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="CacheBlock.__call__">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheBlock.__call__">[docs]</a>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">:</span><span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param arg: argument of the call</span>

<span class="sd">Implements cacheing as follows:</span>

<span class="sd">- Method :meth:`getkey` of the functor is invoked with argument *arg* to obtain a ``ckey``.</span>
<span class="sd">- If that ``ckey`` is present in the (local) memory mapping of this block, its associated value is returned.</span>
<span class="sd">- Otherwise, a transaction is begun on the index database.</span>

<span class="sd">  - If there already exists a cell with the same ``ckey``, method :meth:`lookup` of the storage is invoked to obtain a getter for that cell, then the transaction is terminated and the result is extracted, using the obtained getter. The cell&#39;s hit count is incremented.</span>
<span class="sd">  - If there does not exist a cell with the same ``ckey``, a cell with that ``ckey`` is created, and method :meth:`insert` of the storage is invoked to obtain a setter for that cell, then the transaction is terminated. Then, method :meth:`getval` of the functor is invoked with argument *arg* and its result is stored, even if it is an exception, using the obtained setter.</span>

<span class="sd">- If the result is an exception, it is raised.</span>
<span class="sd">- Otherwise, the memory mapping of this block is updated at key ``ckey`` with the result (if possible), and the result is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">ckey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">functor</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">cval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ckey</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">cval</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN IMMEDIATE TRANSACTION&#39;</span><span class="p">)</span>
      <span class="n">row</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid,size FROM Cell WHERE block=? AND ckey=?&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,</span><span class="n">ckey</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cacheonly</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cache cell creation disallowed&#39;</span><span class="p">)</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO Cell (block,ckey) VALUES (?,?)&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,</span><span class="n">ckey</span><span class="p">))</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="n">setval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">cell</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">getval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> MISS(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
      <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">cval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">functor</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">cval</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span> <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tm</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">size</span> <span class="o">*=</span> <span class="n">setval</span><span class="p">(</span><span class="n">cval</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
          <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Cell WHERE oid=?&#39;</span><span class="p">,(</span><span class="n">cell</span><span class="p">,))</span>
        <span class="k">raise</span>
      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;UPDATE Cell SET size=?, duration=?, tstamp=datetime(</span><span class="se">\&#39;</span><span class="s1">now</span><span class="se">\&#39;</span><span class="s1">) WHERE oid=?&#39;</span><span class="p">,(</span><span class="n">size</span><span class="p">,</span><span class="n">tm</span><span class="p">,</span><span class="n">cell</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">total_changes</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> LOST(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">size</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="n">cval</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WAIT(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
      <span class="n">cval</span> <span class="o">=</span> <span class="n">getval</span><span class="p">()</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> HIT(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;UPDATE Cell SET hits=hits+1, tstamp=datetime(</span><span class="se">\&#39;</span><span class="s1">now</span><span class="se">\&#39;</span><span class="s1">) WHERE oid=?&#39;</span><span class="p">,(</span><span class="n">cell</span><span class="p">,))</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cval</span><span class="p">,</span><span class="ne">BaseException</span><span class="p">):</span> <span class="k">raise</span> <span class="n">cval</span>
    <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">ckey</span><span class="p">]</span> <span class="o">=</span> <span class="n">cval</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">cval</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="c1"># Methods defining the Mapping behaviour</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT ckey, tstamp, hits, size, duration FROM Cell WHERE oid=?&#39;</span><span class="p">,(</span><span class="n">cell</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>

  <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Cell WHERE oid=?&#39;</span><span class="p">,(</span><span class="n">cell</span><span class="p">,))</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">total_changes</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Direct create/update not permitted on Cell&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid FROM Cell WHERE block=?&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,)):</span> <span class="k">yield</span> <span class="n">cell</span>

  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT count(*) FROM Cell WHERE block=?&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="CacheBlock.items">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheBlock.items">[docs]</a>
  <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a view on this instance&#39;s cells.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT oid, ckey, tstamp, hits, size, duration FROM Cell WHERE block=?&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,)):</span>
        <span class="k">yield</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div>


<div class="viewcode-block" id="CacheBlock.clear">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.CacheBlock.clear">[docs]</a>
  <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Removes all cells from this instance.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
      <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM Cell WHERE block=?&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">,))</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="c1"># Representation methods</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

  <span class="k">def</span> <span class="nf">as_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">size_fmt_</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sz</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">size_fmt</span><span class="p">(</span><span class="o">-</span><span class="n">sz</span><span class="p">)</span> <span class="k">if</span> <span class="n">sz</span><span class="o">&lt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">size_fmt</span><span class="p">(</span><span class="n">sz</span><span class="p">)),</span><span class="n">time_fmt_</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">time_fmt</span><span class="p">(</span><span class="n">t</span><span class="p">))):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_html_limit</span>
    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">();</span> <span class="n">closing</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">L</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_html_limit</span><span class="p">);</span> <span class="n">closing</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> more&#39;</span>
    <span class="k">return</span> <span class="n">html_table</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">L</span><span class="p">),</span><span class="n">hdrs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ckey&#39;</span><span class="p">,</span><span class="s1">&#39;tstamp&#39;</span><span class="p">,</span><span class="s1">&#39;hits&#39;</span><span class="p">,</span><span class="s1">&#39;size&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">),</span><span class="n">fmts</span><span class="o">=</span><span class="p">((</span><span class="k">lambda</span> <span class="n">ckey</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">functor</span><span class="o">.</span><span class="n">html</span><span class="p">:</span> <span class="n">h</span><span class="p">(</span><span class="n">ckey</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="n">size_fmt_</span><span class="p">,</span><span class="n">time_fmt_</span><span class="p">),</span><span class="n">opening</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="n">closing</span><span class="o">=</span><span class="n">closing</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Cache&lt;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">functor</span><span class="p">)</span><span class="si">}</span><span class="s1">&gt;&#39;</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="AbstractFunctor">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractFunctor">[docs]</a>
<span class="k">class</span> <span class="nc">AbstractFunctor</span> <span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class defines a type of (single argument) call to be cached.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

<div class="viewcode-block" id="AbstractFunctor.getkey">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractFunctor.getkey">[docs]</a>
  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">def</span> <span class="nf">getkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param arg: an arbitrary python object.</span>

<span class="sd">Returns a byte string which represents *arg* uniquely.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractFunctor.getval">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractFunctor.getval">[docs]</a>
  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">def</span> <span class="nf">getval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param arg: an arbitrary python object.</span>

<span class="sd">Returns the result of calling this functor with argument *arg*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractFunctor.html">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractFunctor.html">[docs]</a>
  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">def</span> <span class="nf">html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ckey</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span><span class="n">_</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param ckey: a byte string as returned by invocation of method :meth:`getkey`</span>

<span class="sd">Returns an HTML formatted representation of the argument of that invocation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="AbstractStorage">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractStorage">[docs]</a>
<span class="k">class</span> <span class="nc">AbstractStorage</span> <span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class stores cached values on a persistent support.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

<div class="viewcode-block" id="AbstractStorage.insert">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractStorage.insert">[docs]</a>
  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param cell: the identifier of a cell</span>

<span class="sd">Returns the function to call to set a cell value. This method is called inside the transaction which inserts a new cell into a cache index, hence exactly once overall for a given cell. The returned function is then called, but outside the transaction. It is passed the computed value and must return the size in bytes of its storage. The cell may have disappeared from the cache when called, or may disappear while executing, so the assignment may have to later be rolled back.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractStorage.lookup">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractStorage.lookup">[docs]</a>
  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">wait</span><span class="p">:</span><span class="nb">bool</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[],</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param cell: the identifier of a cell</span>
<span class="sd">:param wait: whether the cell value is currently being computed by a concurrent thread/process</span>

<span class="sd">Returns the function to call to get a cell value. This method is called inside the transaction which looks up a cell from a cache index, which may happens multiple times in possibly concurrent threads/processes for a given cell. The returned function is then called, but outside the transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractStorage.remove">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.AbstractStorage.remove">[docs]</a>
  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">size</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param cell: the identifier of a cell</span>
<span class="sd">:param size: size of the cell</span>

<span class="sd">Frees the storage resources associated with a cell. This method is called inside the transaction which deletes a cell from a cache index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
</div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="Functor">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor">[docs]</a>
<span class="k">class</span> <span class="nc">Functor</span> <span class="p">(</span><span class="n">AbstractFunctor</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An instance of this class defines a functor attached to a python top-level versioned function. The functor is entirely defined by the name of the function, that of its module, its version and its signature. These components are saved on pickling and restored on unpickling, even if the function has disappeared or changed. This is not checked on unpickling, and method :meth:`getval` is disabled.</span>

<span class="sd">.. automethod:: __new__</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#===================================================================================================</span>

  <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;sig&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span>

  <span class="n">func</span><span class="p">:</span><span class="n">Callable</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;the versioned function characterizing this functor&quot;&quot;&quot;</span>
  <span class="n">sig</span><span class="p">:</span><span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;signature of this functor&quot;&quot;&quot;</span>
  <span class="n">config</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="s1">&#39;Shadow&#39;</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;configuration of this functor&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Functor.__new__">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor.__new__">[docs]</a>
  <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">spec</span><span class="p">,</span><span class="n">fromfunc</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generates a functor.</span>

<span class="sd">:param spec: a versioned function, defined at the top-level of its module (hence pickable)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fromfunc</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">spec</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Shadow</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span><span class="n">sig_dump</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sig_load</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">return</span> <span class="bp">self</span></div>


  <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="kc">False</span>
  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span>
  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">Functor</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">==</span><span class="n">other</span><span class="o">.</span><span class="n">config</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>

<div class="viewcode-block" id="Functor.fpickle">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor.fpickle">[docs]</a>
  <span class="k">class</span> <span class="nc">fpickle</span> <span class="p">(</span><span class="n">pickleclass</span><span class="p">):</span>
<div class="viewcode-block" id="Functor.fpickle.Pickler">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor.fpickle.Pickler">[docs]</a>
    <span class="k">class</span> <span class="nc">Pickler</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Pickler</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">persistent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="s1">&#39;version&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">Shadow</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="Functor.fpickle.Unpickler">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor.fpickle.Unpickler">[docs]</a>
    <span class="k">class</span> <span class="nc">Unpickler</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">persistent_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pid</span><span class="p">):</span> <span class="k">return</span> <span class="n">pid</span></div>
</div>


<div class="viewcode-block" id="Functor.getkey">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor.getkey">[docs]</a>
  <span class="k">def</span> <span class="nf">getkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Argument *arg* must be a pair of a list of positional arguments and a dict of keyword arguments. They are normalised against the signature of the functor and the pickled value of the result is returned. The pickling of versioned function objects is modified to embed their version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span></div>


<div class="viewcode-block" id="Functor.getval">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor.getval">[docs]</a>
  <span class="k">def</span> <span class="nf">getval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Argument *arg* must be a pair of a list of positional arguments and a dict of keyword arguments. Returns the value of calling attribute :attr:`func` with that positional argument list and keyword argument dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="n">arg</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Functor.html">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Functor.html">[docs]</a>
  <span class="k">def</span> <span class="nf">html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ckey</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span><span class="n">_</span><span class="p">):</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ckey</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">html_parlist</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span><span class="p">)</span></div>


  <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]):</span>
    <span class="n">a</span><span class="p">,</span><span class="n">ka</span> <span class="o">=</span> <span class="n">arg</span>
    <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">kwargs</span>

  <span class="k">def</span> <span class="nf">obsolete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">obsolete</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">sig_dump</span><span class="p">(</span><span class="n">sig</span><span class="p">):</span> <span class="k">return</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">sig_load</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">default</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>

<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="FileStorage">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.FileStorage">[docs]</a>
<span class="k">class</span> <span class="nc">FileStorage</span> <span class="p">(</span><span class="n">AbstractStorage</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class manage the persistent storage of cached values using a filesystem directory.</span>

<span class="sd">:param path: the directory to store cached values</span>

<span class="sd">The storage for a cell consists of a content file which contains the value of the cell in pickled format and a cross process mechanism to synchronise access to the content file between writer and possibly multiple readers. The path of the content file as well as that of the file underlying the synch lock are built from the cell id, so as to be unique to that cell. They inherit the access rights of the :attr:`path` directory.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>

  <span class="n">path</span><span class="p">:</span><span class="n">Path</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Directory where values are stored&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mode</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FileStorage.insert">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.FileStorage.insert">[docs]</a>
  <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Opens the content file path for *cell* in write mode, acquires the corresponding synch lock, then returns a setter function which pickle-dumps its argument into the content file, closes it and releases the synch lock.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">setval</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">vfile</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">vfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">vfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">();</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">vfile</span><span class="p">)</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">vfile</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
      <span class="n">vfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="n">synch_close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">s</span>
    <span class="n">vpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpath</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">vfile</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">vpath</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">&amp;</span><span class="mo">0o666</span><span class="p">)</span>
    <span class="n">synch_close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_synch</span><span class="p">(</span><span class="n">vpath</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">setval</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FileStorage.lookup">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.FileStorage.lookup">[docs]</a>
  <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">wait</span><span class="p">:</span><span class="nb">bool</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[],</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Opens the content file path for *cell* in read mode, then returns a getter function which waits for the corresponding synch lock to be released (if *wait* is True), then pickle-loads the content file and returns the obtained value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">vpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpath</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">vfile</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">wait_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_synch</span><span class="p">(</span><span class="n">vpath</span><span class="p">)</span> <span class="k">if</span> <span class="n">wait</span> <span class="k">else</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">getval</span><span class="p">():</span>
      <span class="n">wait_</span><span class="p">()</span>
      <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">vfile</span><span class="p">)</span>
      <span class="k">finally</span><span class="p">:</span> <span class="n">vfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">getval</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FileStorage.remove">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.FileStorage.remove">[docs]</a>
  <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">size</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Removes the content file path for *cell* as well as the corresponding synch lock.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">vpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpath</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">vpath</span><span class="o">.</span><span class="n">unlink</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_synch</span><span class="p">(</span><span class="n">vpath</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FileStorage.getpath">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.FileStorage.getpath">[docs]</a>
  <span class="k">def</span> <span class="nf">getpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">masks</span><span class="o">=</span><span class="nb">tuple</span><span class="p">((</span><span class="mi">5</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="mi">31</span><span class="o">*</span><span class="mi">32</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns the content file path (as a :class:`pathlib.Path` instance) associated to *cell* (of type :class:`int`). It is composed of two parts (a directory name and a file name), joined to the main :attr:`path` attribute. The directory is created if it does not already exist. The concatenation of the directory name (without its prefix ``X``) and the file name (without its suffix ``.pck``) is the representation of *cell* in base 32 (digits are 0-9A-V). This mapping of cells to paths ensures that no sub-directory holds more than 1024 cells. It assumes that cells are created sequentially (which is what AUTOINCREMENT in sqlite3 does), so the number of sub-directories grows slowly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;0123456789ABCDEFGHIJKLMNOPQRSTUV&#39;</span><span class="p">[(</span><span class="n">cell</span><span class="o">&amp;</span><span class="n">m</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">[:</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">p</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pck&#39;</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<span class="c1"># Synchronisation mechanism based on sqlite (for portability: could probably be simplified)</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">insert_synch</span><span class="p">(</span><span class="n">vpath</span><span class="p">:</span><span class="n">Path</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[],</span><span class="kc">None</span><span class="p">]:</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.tmp&#39;</span><span class="p">)</span>
    <span class="n">tpath</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
    <span class="n">tpath</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">vpath</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>
    <span class="n">synch</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tpath</span><span class="p">))</span>
    <span class="n">synch</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN EXCLUSIVE TRANSACTION&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">synch</span><span class="o">.</span><span class="n">close</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">lookup_synch</span><span class="p">(</span><span class="n">vpath</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">timeout</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">600.</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Callable</span><span class="p">[[],</span><span class="kc">None</span><span class="p">]:</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.tmp&#39;</span><span class="p">)</span>
    <span class="n">synch</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tpath</span><span class="p">),</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wait</span><span class="p">():</span>
      <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="n">synch</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;synch file lost!&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">synch</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN IMMEDIATE TRANSACTION&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;database is locked&#39;</span><span class="p">:</span> <span class="n">synch</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="k">raise</span>
          <span class="k">continue</span>
        <span class="k">break</span>
      <span class="n">synch</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wait</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">remove_synch</span><span class="p">(</span><span class="n">vpath</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.tmp&#39;</span><span class="p">)</span>
    <span class="n">tpath</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<span class="c1">#==================================================================================================</span>
<div class="viewcode-block" id="DefaultStorage">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.DefaultStorage">[docs]</a>
<span class="k">class</span> <span class="nc">DefaultStorage</span> <span class="p">(</span><span class="n">FileStorage</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The default storage class for a cache repository. Stores the index database in the same directory as the values, with name ``index.db``.</span>

<span class="sd">Attributes:</span>

<span class="sd">.. attribute:: dbpath</span>

<span class="sd">   The :class:`pathlib.Path` to the sqlite database holding the index</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#==================================================================================================</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dbpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s1">&#39;index.db&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot create new index in non empty directory&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dbpath</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dbpath</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">&amp;</span><span class="mo">0o666</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================</span>
<span class="c1"># Utilities</span>
<span class="c1">#==================================================================================================</span>

<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="persistent_cache">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.persistent_cache">[docs]</a>
<span class="k">def</span> <span class="nf">persistent_cache</span><span class="p">(</span><span class="n">f</span><span class="p">:</span><span class="n">Callable</span><span class="p">,</span><span class="n">factory</span><span class="o">=</span><span class="n">CacheBlock</span><span class="p">,</span><span class="o">**</span><span class="n">kwd</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A decorator which makes a function persistently cached. The cached function behaves as the original function except that its invocations are cached and reused when possible. The original function must be defined at the top-level of its module, to be compatible with :class:`Functor`. If it does not have a version already, it is assigned version :const:`None`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="k">assert</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;version&#39;</span><span class="p">):</span> <span class="n">f</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">factory</span><span class="p">(</span><span class="n">functor</span><span class="o">=</span><span class="n">Functor</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="o">**</span><span class="n">kwd</span><span class="p">)</span>
  <span class="n">F</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">ka</span><span class="p">:</span> <span class="n">c</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">ka</span><span class="p">))</span>
  <span class="n">F</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">c</span>
  <span class="k">return</span> <span class="n">update_wrapper</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="n">f</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Shadow">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Shadow">[docs]</a>
<span class="k">class</span> <span class="nc">Shadow</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instances of this class are defined from versioned functions (ie. functions defined at the toplevel of their module, and with an attribute :attr:`version` defined). Their state is composed of the name, the module name and the version of the original function. They can be arbitrarily pickled and unpickled and produce a string representation close to that of their origin. However, unpickling does not restore the calling capacity of their origin.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>

  <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span>

  <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">spec</span><span class="p">,</span><span class="n">fromfunc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fromfunc</span><span class="p">:</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span><span class="n">spec</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">return</span> <span class="bp">self</span>
  <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="kc">False</span>
  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span>
  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">Shadow</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">==</span><span class="n">other</span><span class="o">.</span><span class="n">config</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">module</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module</span><span class="p">,</span><span class="n">name</span><span class="p">,(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Shadow.obsolete">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.Shadow.obsolete">[docs]</a>
  <span class="k">def</span> <span class="nf">obsolete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Returns :const:`None` if this instance is up-to-date. It may be obsolete for two reasons:</span>

<span class="sd">* the function it refers to (by module name and function name) cannot be imported or is not a versioned function: in that case the empty tuple is returned;</span>
<span class="sd">* it can be imported as a versioned function, but has a different version from that of this instance: in that case, the pair of the current version of the imported function and the version of this instance is returned.</span>

<span class="sd">Note that this method may import modules which in turn may create cache entries (for new versions of functions). It should therefore not be called in a cache transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
    <span class="n">module</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">),</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="vm">__module__</span><span class="o">==</span><span class="n">module</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="o">==</span><span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">version</span><span class="o">==</span><span class="n">version</span> <span class="k">else</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">version</span><span class="p">,</span><span class="n">version</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="p">()</span></div>
</div>


<span class="c1">#--------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="manage">
<a class="viewcode-back" href="../../mod_cache.html#PYTOOLS.cache.manage">[docs]</a>
<span class="k">def</span> <span class="nf">manage</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span><span class="n">ivname</span><span class="o">=</span><span class="s1">&#39;db&#39;</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A simple tool to manage a set of :class:`CacheDB` instances, specified by their paths.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<span class="c1">#--------------------------------------------------------------------------------------------------</span>
  <span class="kn">import</span> <span class="nn">ipywidgets</span>
  <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span><span class="p">,</span> <span class="n">display</span>
  <span class="kn">from</span> <span class="nn">IPython.core.getipython</span> <span class="kn">import</span> <span class="n">get_ipython</span>
  <span class="k">def</span> <span class="nf">setdb</span><span class="p">(</span><span class="n">c</span><span class="p">):</span> <span class="k">nonlocal</span> <span class="n">db</span><span class="p">;</span> <span class="n">db</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">new</span><span class="p">;</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">push</span><span class="p">({</span><span class="n">ivname</span><span class="p">:</span><span class="n">db</span><span class="p">});</span> <span class="n">showdb</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">showdb</span><span class="p">():</span>
    <span class="n">wmsg</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">wout</span><span class="p">:</span> <span class="n">clear_output</span><span class="p">();</span> <span class="n">display</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">runc</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">label</span><span class="p">,</span><span class="n">op</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">new</span>
    <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">wautorun</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">autorun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">with</span> <span class="n">wmsg</span><span class="p">:</span>
        <span class="n">clear_output</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Operation:&#39;</span><span class="p">,</span><span class="s1">&#39;clear&#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;(dryrun: </span><span class="si">{</span><span class="n">ivname</span><span class="si">}</span><span class="s1"> unchanged)&#39;</span> <span class="k">if</span> <span class="n">wdryrun</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">op</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result:&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wdryrun</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="n">r</span><span class="p">:</span>
      <span class="k">with</span> <span class="n">wout</span><span class="p">:</span> <span class="n">clear_output</span><span class="p">();</span> <span class="n">display</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
  <span class="n">autorun</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;clear...&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">block</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">clear_error</span><span class="p">(</span><span class="n">dry_run</span><span class="o">=</span><span class="n">wdryrun</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])),</span>
    <span class="p">(</span><span class="s1">&#39;Obsolete&#39;</span><span class="p">,(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">clear_obsolete</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">dry_run</span><span class="o">=</span><span class="n">wdryrun</span><span class="o">.</span><span class="n">value</span><span class="p">))),</span>
    <span class="p">(</span><span class="s1">&#39;ObsoleteStrict&#39;</span><span class="p">,(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">clear_obsolete</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">dry_run</span><span class="o">=</span><span class="n">wdryrun</span><span class="o">.</span><span class="n">value</span><span class="p">))),</span>
  <span class="p">)</span>
  <span class="n">db</span><span class="p">:</span><span class="n">CacheDB</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">interpreter</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
  <span class="n">interpreter</span><span class="o">.</span><span class="n">push</span><span class="p">({</span><span class="n">ivname</span><span class="p">:</span><span class="n">db</span><span class="p">})</span>
  <span class="n">wdb</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">ivname</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">chain</span><span class="p">(((</span><span class="s1">&#39;...&#39;</span><span class="p">,()),),((</span><span class="n">p</span><span class="p">,</span><span class="n">CacheDB</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">))),</span><span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span><span class="s1">&#39;initial&#39;</span><span class="p">})</span>
  <span class="n">wshow</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">tooltip</span><span class="o">=</span><span class="s1">&#39;show db&#39;</span><span class="p">,</span><span class="n">icon</span><span class="o">=</span><span class="s1">&#39;fa-refresh&#39;</span><span class="p">,</span><span class="n">layout</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;.4cm&#39;</span><span class="p">,</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;0cm&#39;</span><span class="p">))</span>
  <span class="n">wautorun</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">autorun</span><span class="p">],</span><span class="n">layout</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;3cm&#39;</span><span class="p">))</span>
  <span class="n">wdryrun</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;dry-run&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span><span class="s1">&#39;initial&#39;</span><span class="p">})</span>
  <span class="n">wout</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
  <span class="n">wmsg</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">border</span><span class="o">=</span><span class="s1">&#39;thin solid black&#39;</span><span class="p">))</span>
  <span class="n">wdb</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">setdb</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
  <span class="n">wautorun</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">runc</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
  <span class="n">wshow</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">showdb</span><span class="p">())</span>
  <span class="n">showdb</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">(</span><span class="n">ipywidgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">(</span><span class="n">wdb</span><span class="p">,</span><span class="n">wshow</span><span class="p">,</span><span class="n">wautorun</span><span class="p">,</span><span class="n">wdryrun</span><span class="p">)),</span><span class="n">wmsg</span><span class="p">,</span><span class="n">wout</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Jean-Marc Andreoli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>